<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ªçn Gh·∫ø Xem Phim</title>
    <link rel="stylesheet" th:href="@{/css/layout/layout.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <meta name="_csrf_parameterName" th:content="${_csrf.parameterName}" />
    <style>
        body {
            background-color: #0b1020;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        h2 {
            color: #4db2f8;
            text-align: center;
            margin-top: 70px;
        }
        .booking-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-top: 30px;
            padding-left: 50px;
            padding-right: 50px;
            flex-direction: row-reverse;
        }
        .left-info {
            flex: 1;
            min-width: 280px;
            max-width: 400px;
            padding: 25px;
            background-color: #1a1a2e;
            border-radius: 16px;
        }
        .right-seats {
            flex: 2;
            min-width: 300px;
        }
        .movie-title {
            font-size: 18px;
            font-weight: bold;
            color: #4db2f8;
            margin-bottom: 10px;
        }
        .movie-details {
            font-size: 15px;
            color: #b2bec3;
            margin-bottom: 25px;
        }
        .dropdown select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #4db2f8;
            background-color: #0b132b;
            font-size: 14px;
            color: #ffffff;
        }
        .checkout-btn {
            background: linear-gradient(to right, #1dd1a1, #ff6b6b);
            color: white;
            border: none;
            padding: 12px;
            font-size: 16px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .checkout-btn:hover {
            opacity: 0.9;
        }
        .checkout-btn:disabled {
            margin-top: 10px;
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .screen {
            background-color: rgba(255, 215, 0, 0.1);
            text-align: center;
            padding: 10px;
            font-weight: bold;
            margin-bottom: 15px;
            border-radius: 10px;
            color: #ffd700;
        }
        .seat-map {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }
        .seat-grid {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-bottom: 6px;
        }
        .seat {
            width: 40px;
            height: 40px;
            line-height: 40px;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            color: #fff;
            transition: all 0.2s ease;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.2);
            user-select: none;
            user-drag: none;
            margin: 2px;
        }
        .seat:hover {
            background-color: #666;
        }
        .seat.selected {
            background-color: #1dd1a1;
            color: #000;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 0 12px 4px #1dd1a1;
            transform: scale(1.05);
            transition: all 0.2s ease;
        }
        .seat.normal {
            background-color: #4e73df;
        }
        .seat.vip {
            background-color: #e74c3c;
        }
        .seat.couple {
            background-color: #9b59b6;
        }
        .seat.premium {
            background-color: #f1c40f;
        }
        .seat.reserved {
            background-color: #5e5e5e;
            color: #ffffff;
            cursor: not-allowed;
        }
        .seat.empty {
            visibility: hidden;
            pointer-events: none;
        }
        .seat.staircase {
            background-color: #333;
            color: #ffd700;
            font-weight: bold;
            cursor: default;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            pointer-events: none;
        }
        .seat.disabled {
            background-color: #222 !important;
            color: #666 !important;
            cursor: not-allowed !important;
        }
        .couple-seat-container {
            display: flex;
            gap: 4px;
            border-radius: 8px;
            padding: 4px;
            background-color: rgba(155, 89, 182, 0.2);
            position: relative;
            margin: 2px;
            border: 1px solid #ffc755;
        }
        .couple-seat-container .seat {
            margin: 0;
        }
        .couple-seat-container:hover .seat:not(.reserved):not(.selected) {
            background-color: #b070c8;
        }
        .couple-seat-container.selected .seat {
            border: 2px solid #fff;
            box-shadow: 0 0 12px 4px #1dd1a1;
        }
        .couple-seat-container.disabled {
            background-color: rgba(34, 34, 34, 0.5) !important;
            cursor: not-allowed !important;
        }
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            font-size: 14px;
            color: #b2bec3;
            justify-content: center;
        }
        .legend-box {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            display: inline-block;
            margin-right: 6px;
            vertical-align: middle;
            background-color: #444;
        }
        .legend-box.normal { background-color: #4e73df; }
        .legend-box.vip { background-color: #e74c3c; }
        .legend-box.couple { background-color: #9b59b6; }
        .legend-box.premium { background-color: #f1c40f; }
        .legend-box.selected {
            background-color: #00cec9;
            box-shadow: 0 0 5px #00cec9;
        }
        .legend-box.reserved {
            background-color: #5e5e5e;
        }
        .summary-item {
            margin-top: 10px;
            font-size: 15px;
            color: #ffffff;
        }
        .total-price {
            color: #ffd700;
            font-weight: bold;
        }
        .popup {
            display: none;
            background-color: #1abc9c;
            color: #fff;
            padding: 12px 20px;
            border-radius: 10px;
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 999;
        }
        .popup.success {
            background-color: #27ae60;
        }
        .movie-box {
            background-color: #0b1020;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            font-family: 'Segoe UI', sans-serif;
            margin: 20px auto;
        }
        .movie-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 12px;
            text-align: center;
        }
        .movie-details div {
            margin-bottom: 8px;
            font-size: 1rem;
            color: #ffffff;
        }
        .movie-details strong {
            display: inline-block;
            width: 130px;
            color: #ffffff;
        }
        .quantity-buttons {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            flex-wrap: wrap;
            position: relative;
        }
        .quantity-buttons button {
            padding: 10px 16px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            background-color: #4db2f8;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .quantity-buttons button:disabled {
            background-color: #555 !important;
            color: #aaa;
            cursor: not-allowed;
            box-shadow: none;
        }
        .quantity-buttons button:hover:not(:disabled) {
            background-color: #1b8cdc;
        }
        .quantity-buttons button.active-btn {
            background-color: #1dd1a1;
            color: #fff;
            box-shadow: 0 0 8px #1dd1a1;
        }
        .reset-btn {
            position: absolute;
            right: -10px;
            background-color: #1dd1a1;
            color: white;
            border: none;
            width: 40px;
            height: 36px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(29, 209, 161, 0.5);
            transition: transform 0.3s ease;
        }
        .reset-btn:hover {
            transform: rotate(360deg) scale(1.1);
            background-color: #1abc9c;
        }
        .seat-help-icon {
            cursor: pointer;
            margin-left: 8px;
            font-size: 18px;
            color: #ffd700;
            position: relative;
            z-index: 100;
        }
        .seat-help-popup {
            display: none;
            position: absolute;
            background-color: #1a1a2e;
            color: #ffffff;
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px solid #4db2f8;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            max-width: 300px;
            font-size: 14px;
            z-index: 9999;
        }
        .seat-help-popup.show {
            display: block;
        }
        .seat-help-popup::after {
            content: '';
            position: absolute;
            top: -10px;
            left: 20px;
            border-width: 0 10px 10px 10px;
            border-style: solid;
            border-color: transparent transparent #1a1a2e transparent;
        }
        .price-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .price-popup-overlay.show {
            display: flex;
            opacity: 1;
        }
        .price-popup {
            background: #1a1a2e;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            padding: 20px;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .price-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .price-popup-title {
            font-size: 1.5rem;
            color: #4db2f8;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .price-popup-close {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .price-popup-close:hover {
            color: #ff6b6b;
        }
        .price-popup-content {
            color: #b2bec3;
            font-size: 14px;
        }
        .price-intro {
            margin-bottom: 20px;
            text-align: center;
            color: #ffffff;
        }
        .price-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .price-table th,
        .price-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #4db2f8;
        }
        .price-table th {
            color: #4db2f8;
            font-weight: bold;
        }
        .price-table td {
            color: #ffffff;
        }
        .seat-type-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .seat-type-color {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }
        .seat-type-color.normal { background-color: #4e73df; }
        .seat-type-color.vip { background-color: #e74c3c; }
        .seat-type-color.couple { background-color: #9b59b6; }
        .seat-type-color.premium { background-color: #f1c40f; }
        .price-value {
            color: #ffd700;
            font-weight: bold;
        }
        .price-notes {
            background: #0b1020;
            padding: 15px;
            border-radius: 8px;
        }
        .price-notes h4 {
            color: #4db2f8;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .price-notes ul {
            list-style: none;
            padding: 0;
            color: #b2bec3;
        }
        .price-notes li {
            margin-bottom: 8px;
            position: relative;
            padding-left: 20px;
        }
        .price-notes li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: #4db2f8;
        }
        .age-warning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .age-warning-overlay.show {
            display: flex;
            opacity: 1;
        }
        .age-warning-box {
            background: #1a1a2e;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            text-align: center;
            position: relative;
            border: 1px solid #4db2f8;
        }
        .age-warning-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        .age-warning-title {
            font-size: 1.6rem;
            font-weight: bold;
            color: #4db2f8;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .age-warning-icon {
            font-size: 1.8rem;
            color: #ffd700;
        }
        .age-warning-text {
            font-size: 1rem;
            color: #b2bec3;
            line-height: 1.5;
            margin-bottom: 20px;
            white-space: pre-line;
        }
        .age-warning-checkbox {
            align-items: center;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .age-warning-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #1dd1a1;
        }
        .age-warning-checkbox label {
            font-size: 0.95rem;
            color: #ffffff;
        }
        .age-warning-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .age-warning-buttons button {
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .age-warning-buttons button.confirm {
            background: linear-gradient(to right, #1dd1a1, #4db2f8);
            color: white;
        }
        .age-warning-buttons button.confirm:hover {
            opacity: 0.9;
            box-shadow: 0 0 10px rgba(29, 209, 161, 0.5);
        }
        .age-warning-buttons button.cancel {
            background: #ff6b6b;
            color: white;
        }
        .age-warning-buttons button.cancel:hover {
            opacity: 0.9;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
        .age-warning-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .age-warning-close:hover {
            color: #ff6b6b;
        }
        #priceBtn {
            background-color: #3033c2;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 28px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        #priceBtn i {
            font-size: 18px;
        }
        #priceBtn:hover {
            background-color: #218838;
            box-shadow: 0 6px 12px rgba(33, 136, 56, 0.5);
        }
        @media (max-width: 768px) {
            .booking-content {
                flex-direction: column;
            }
            .seat-map {
                grid-template-columns: repeat(5, 1fr);
            }
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div class="container">
    <h2>
        Ch·ªçn Gh·∫ø C·ªßa B·∫°n
        <span id="helpIcon" title="H∆∞·ªõng d·∫´n" class="seat-help-icon">‚ùì</span>
    </h2>
    <div id="seatHelp" class="seat-help-popup">
        <strong>ü™ë H∆∞·ªõng d·∫´n ch·ªçn gh·∫ø:</strong><br><br>
        ‚Ä¢ Ch·ªçn s·ªë l∆∞·ª£ng gh·∫ø tr∆∞·ªõc (1‚Äì4).<br>
        ‚Ä¢ Click 1 gh·∫ø ƒë·ªÉ ch·ªçn nh√≥m li·ªÅn k·ªÅ.<br>
        ‚Ä¢ Click chu·ªôt ph·∫£i ƒë·ªÉ b·ªè ch·ªçn gh·∫ø ho·∫∑c nh√≥m gh·∫ø.<br>
        ‚Ä¢ B·∫•m ‚ü≥ ƒë·ªÉ reset t·∫•t c·∫£.<br>
        ‚Ä¢ T·ªëi ƒëa 8 gh·∫ø/l∆∞·ª£t.<br>
        ‚Ä¢ Gh·∫ø ƒë√¥i (couple) c√≥ vi·ªÅn v√†ng bao quanh v√† ch·ªâ ch·ªçn ƒë∆∞·ª£c khi l·ª±a ch·ªçn s·ªë l∆∞·ª£ng gh·∫ø l√† 2.
    </div>
    <div class="booking-content">
        <div class="right-seats">
            <div class="screen">M√ÄN H√åNH
                <div id="countdownTimer" style="font-weight: bold; color: red; margin-top: 12px;"></div>
            </div>
            <div class="seat-map" id="seatMap"></div>
            <div class="legend" id="legend"></div>
        </div>
        <div class="left-info">
            <div class="movie-box">
                <div class="movie-title" th:text="${movie.getMovieName() ?: 'T√™n Phim'}"></div>
                <div class="movie-details">
                    <div><strong>Phi√™n b·∫£n:</strong> <span th:text="${movie.getVersionName() ?: 'Ch∆∞a r√µ'}"></span></div>
                    <div><strong>ƒê·ªô tu·ªïi:</strong> <span th:text="${movie.getRatingName() ?: 'Ch∆∞a r√µ'}"></span></div>
                    <div><strong>Ng√†y chi·∫øu:</strong> <span th:text="${#temporals.format(movie.getShowDate(), 'dd/MM/yyyy') ?: 'Ch∆∞a r√µ'}"></span></div>
                    <div><strong>Gi·ªù chi·∫øu:</strong> <span th:text="${#temporals.format(movie.getScheduleTime(), 'HH:mm') ?: 'Ch∆∞a r√µ'}"></span></div>
                    <div><strong>Ph√≤ng:</strong> <span th:text="${movie.getRoomName() ?: 'Ch∆∞a r√µ'}"></span></div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="price-btn" id="priceBtn">
                        <i class="bi bi-currency-dollar"></i>
                        Xem b·∫£ng gi√°
                    </button>
                </div>
            </div>
            <div><strong>Ch·ªçn gh·∫ø li·ªÅn nhau</strong></div>
            <div class="quantity-buttons">
                <button type="button" onclick="setQuantity(1)">1 gh·∫ø</button>
                <button type="button" onclick="setQuantity(2)">2 gh·∫ø</button>
                <button type="button" onclick="setQuantity(3)">3 gh·∫ø</button>
                <button type="button" onclick="setQuantity(4)">4 gh·∫ø</button>
                <button type="button" id="resetBtn" class="reset-btn" title="Reset gh·∫ø ƒë√£ ch·ªçn">
                    ‚ü≥
                </button>
            </div>
            <div class="selection-summary" id="selectionSummary" style="display: none;">
                <div class="summary-item">
                    <span>Gh·∫ø ƒë√£ ch·ªçn:</span>
                    <span id="selectedSeatsText">-</span>
                </div>
                <div class="summary-item">
                    <span>S·ªë l∆∞·ª£ng:</span>
                    <span id="selectedCount">0</span>
                </div>
                <div class="summary-item total-price">
                    <span>T·ªïng ti·ªÅn:</span>
                    <span id="totalPrice">0 VNƒê</span>
                </div>
            </div>
            <button sec:authorize="!hasRole('ADMIN')" class="checkout-btn" id="checkoutBtn" disabled>
                <span id="btnText">Ch·ªçn gh·∫ø ƒë·ªÉ ti·∫øp t·ª•c</span>
            </button>
        </div>
    </div>
    <form id="bookingForm" th:action="@{/confirm}" method="post">
        <input type="hidden" name="selectedSeats" id="selectedSeatsInput">
        <input type="hidden" name="quantity" id="quantityInput">
        <input type="hidden" name="totalPrice" id="totalPriceInput">
        <input type="hidden" name="seatIds" id="seatIdsInput">
        <input type="hidden" name="scheduleSeatIds" id="scheduleSeatIdsInput">
        <input type="hidden" name="showtimeId" id="showtimeIdInput">
        <input type="hidden" id="expireAtInput" name="expireAt" />
        <input type="hidden" id="movieId" name="movieId" th:value="${movieId}"/>
        <input type="hidden" id="invoiceId" name="invoiceId"/>
<!--        <div th:if="${session.invoiceId != null}">-->
<!--            <p>Session t·ªìn t·∫°i! ID: <span th:text="${session.invoiceId}"></span></p>-->
<!--        </div>-->
    </form>
    <div class="popup" id="popup">Th√¥ng b√°o</div>
    <div id="ageWarningPopup" class="age-warning-overlay">
        <div class="age-warning-box">
            <button class="age-warning-close" onclick="closeAgePopup()">
                <i class="bi bi-x-lg"></i>
            </button>
            <div class="age-warning-header">
                <span class="age-warning-icon">üé¨</span>
                <h3 class="age-warning-title">X√°c nh·∫≠n ƒë·ªô tu·ªïi</h3>
            </div>
            <p id="ageWarningText" class="age-warning-text"></p>
            <div class="age-warning-checkbox">
                <input type="checkbox" id="ageConfirmCheckbox" />
                <label for="ageConfirmCheckbox">T√¥i x√°c nh·∫≠n v√† ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu ki·ªán v·ªÅ ƒë·ªô tu·ªïi xem phim theo ph√¢n lo·∫°i tr√™n.</label>
            </div>
            <div class="age-warning-buttons">
                <button class="confirm" onclick="confirmAgeAgreement()">ƒê·ªìng √Ω v√† ti·∫øp t·ª•c</button>
                <button class="cancel" onclick="closeAgePopup()">H·ªßy</button>
            </div>
        </div>
    </div>
    <div class="price-popup-overlay" id="pricePopupOverlay">
        <div class="price-popup">
            <div class="price-popup-header">
                <h3 class="price-popup-title">
                    <i class="bi bi-currency-dollar"></i>
                    B·∫£ng Gi√° V√©
                </h3>
                <button class="price-popup-close" id="pricePopupClose">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="price-popup-content">
                <p class="price-intro">
                    Kh√°m ph√° c√°c lo·∫°i gh·∫ø v√† m·ª©c gi√° t∆∞∆°ng ·ª©ng cho tr·∫£i nghi·ªám xem phim tuy·ªát v·ªùi
                </p>
                <table class="price-table" id="priceTable">
                    <thead>
                    <tr>
                        <th>Lo·∫°i Gh·∫ø</th>
                        <th>Gi√° V√©</th>
                        <th>ƒê·∫∑c ƒêi·ªÉm</th>
                    </tr>
                    </thead>
                    <tbody id="priceTableBody"></tbody>
                </table>
                <div class="price-notes">
                    <h4>
                        <i class="bi bi-info-circle"></i>
                        L∆∞u √Ω quan tr·ªçng
                    </h4>
                    <ul>
                        <li>Gi√° v√© c√≥ th·ªÉ thay ƒë·ªïi theo khung gi·ªù chi·∫øu</li>
                        <li>Khuy·∫øn m√£i ƒë·∫∑c bi·ªát √°p d·ª•ng cho th√†nh vi√™n VIP</li>
                        <li>Mi·ªÖn ph√≠ n∆∞·ªõc u·ªëng cho gh·∫ø Premium v√† Couple</li>
                        <li>H·ªó tr·ª£ ƒë·∫∑t tr∆∞·ªõc 30 ng√†y, ho√†n ti·ªÅn 100%</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<script th:inline="javascript">
    const seatData = /*[[${seats}]]*/ [];
    const ratingCode = /*[[${movie.ratingCode}]]*/ 'P';
    const coupleSeatsData = /*[[${mapSeatsCouple}]]*/ {};
    const seatMap = document.getElementById("seatMap");
    const popup = document.getElementById("popup");
    const checkoutBtn = document.getElementById("checkoutBtn");
    const selectionSummary = document.getElementById("selectionSummary");
    const selectedSeatsText = document.getElementById("selectedSeatsText");
    const selectedCountText = document.getElementById("selectedCount");
    const totalPriceText = document.getElementById("totalPrice");
    const btnText = document.getElementById("btnText");
    const resetBtn = document.getElementById("resetBtn");
    const form = document.querySelector("form");
    const MAX_SEATS = 8;
    let desiredQuantity = 0;
    let selectedSeats = [];
    let selectedGroups = new Map();
    const seatInfoMap = {};

    seatData.forEach(seat => {
        const code = seat.seatColumn + seat.seatRow;
        seatInfoMap[code] = seat;
    });

    const coupleSeatPairs = {};
    Object.keys(coupleSeatsData).forEach(key => {
        const seat = coupleSeatsData[key];
        const index = parseInt(key);
        const isOdd = index % 2 === 1;
        const pairIndex = isOdd ? index + 1 : index - 1;
        const seatCode = seat.seatColumn + seat.seatRow;
        coupleSeatPairs[seatCode] = {
            seatId: seat.seatId,
            pairSeatId: null, // Kh·ªüi t·∫°o pairSeatId l√† null
            code: seatCode,
            pairCode: null
        };

        // T√¨m c·∫∑p gh·∫ø d·ª±a tr√™n kh√≥a li·ªÅn k·ªÅ
        const pairKey = Object.keys(coupleSeatsData).find(k => parseInt(k) === pairIndex);
        if (pairKey) {
            const pairSeat = coupleSeatsData[pairKey];
            const pairCode = pairSeat.seatColumn + pairSeat.seatRow;
            coupleSeatPairs[seatCode].pairSeatId = pairSeat.seatId;
            coupleSeatPairs[seatCode].pairCode = pairCode;
            coupleSeatPairs[pairCode] = {
                seatId: pairSeat.seatId,
                pairSeatId: seat.seatId,
                code: pairCode,
                pairCode: seatCode
            };
        }
    });
    function showPopup(message, isSuccess = false) {
        popup.textContent = message;
        popup.className = "popup" + (isSuccess ? " success" : "");
        popup.style.display = "block";
        setTimeout(() => popup.style.display = "none", 3000);
    }

    function formatPrice(price) {
        return new Intl.NumberFormat('vi-VN').format(price) + ' VNƒê';
    }

    function updateSelectionSummary() {
        const count = selectedSeats.length;
        if (count > 0) {
            selectionSummary.style.display = "block";
            selectedSeatsText.textContent = selectedSeats.join(", ");
            selectedCountText.textContent = count;
            const total = selectedSeats.reduce((sum, code) => {
                const seat = seatInfoMap[code];
                const price = seat && seat.seatTypeName?.toLowerCase() === "couple"
                    ? (seat.seatPrice || 0) / 2
                    : (seat.seatPrice || 0);
                return sum + price;
            }, 0);
            totalPriceText.textContent = formatPrice(total);
        } else {
            selectionSummary.style.display = "none";
        }
        updateCoupleSeatsAvailability();
    }

    // New function to disable couple seats when desired quantity is not 2
    function updateCoupleSeatsAvailability() {
        const coupleSeats = document.querySelectorAll('.seat.couple');
        const coupleContainers = document.querySelectorAll('.couple-seat-container');
        if (desiredQuantity === 0) {
            // Khi ch∆∞a ch·ªçn s·ªë l∆∞·ª£ng gh·∫ø, gi·ªØ m√†u b√¨nh th∆∞·ªùng v√† cho ph√©p t∆∞∆°ng t√°c
            coupleSeats.forEach(seat => {
                if (!seat.classList.contains('selected') && !seat.classList.contains('reserved')) {
                    seat.classList.remove('disabled');
                    seat.style.pointerEvents = 'auto';
                }
            });
            coupleContainers.forEach(container => {
                if (!container.classList.contains('selected')) {
                    container.classList.remove('disabled');
                    container.style.pointerEvents = 'auto';
                }
            });
        } else if (desiredQuantity !== 2) {
            // Khi s·ªë l∆∞·ª£ng gh·∫ø kh√¥ng ph·∫£i 2, v√¥ hi·ªáu h√≥a gh·∫ø ƒë√¥i
            coupleSeats.forEach(seat => {
                if (!seat.classList.contains('selected') && !seat.classList.contains('reserved')) {
                    seat.classList.add('disabled');
                    seat.style.pointerEvents = 'none';
                }
            });
            coupleContainers.forEach(container => {
                if (!container.classList.contains('selected')) {
                    container.classList.add('disabled');
                    container.style.pointerEvents = 'none';
                }
            });
        } else {
            // Khi s·ªë l∆∞·ª£ng gh·∫ø l√† 2, cho ph√©p ch·ªçn gh·∫ø ƒë√¥i
            coupleSeats.forEach(seat => {
                if (!seat.classList.contains('selected') && !seat.classList.contains('reserved')) {
                    seat.classList.remove('disabled');
                    seat.style.pointerEvents = 'auto';
                }
            });
            coupleContainers.forEach(container => {
                if (!container.classList.contains('selected')) {
                    container.classList.remove('disabled');
                    container.style.pointerEvents = 'auto';
                }
            });
        }
    }

    function lockInvalidRows(qty) {
        const rows = [...new Set(seatData.map(s => s.seatRow))];
        rows.forEach(row => {
            const seatsInRow = seatData
                .filter(s => s.seatRow === row)
                .sort((a, b) => a.seatColumn.charCodeAt(0) - b.seatColumn.charCodeAt(0));
            let segments = [], currentSegment = [];
            for (const seat of seatsInRow) {
                if (seat.seatTypeId === 4 || seat.seatTypeId === 5 || seat.isBooked || selectedSeats.includes(seat.seatColumn + seat.seatRow)) {
                    if (currentSegment.length) segments.push(currentSegment);
                    currentSegment = [];
                } else {
                    currentSegment.push(seat);
                }
            }
            if (currentSegment.length) segments.push(currentSegment);
            let validCodes = new Set();
            segments.forEach(segment => {
                if (segment.length < qty) return;
                for (let i = 0; i <= segment.length - qty; i++) {
                    const group = segment.slice(i, i + qty);
                    let isValid = true;
                    for (let j = 0; j < group.length; j++) {
                        const seat = group[j];
                        const code = seat.seatColumn + seat.seatRow;
                        if (seat.isBooked || seat.seatTypeId === 4 || seat.seatTypeId === 5) {
                            isValid = false;
                            break;
                        }
                        if (j > 0) {
                            const prevChar = group[j - 1].seatColumn.charCodeAt(0);
                            const currChar = seat.seatColumn.charCodeAt(0);
                            if (currChar !== prevChar + 1) {
                                isValid = false;
                                break;
                            }
                            const inBetweenCode = String.fromCharCode(prevChar + 1) + seat.seatRow;
                            const betweenSeat = seatInfoMap[inBetweenCode];
                            if (betweenSeat && betweenSeat.seatTypeId === 5) {
                                isValid = false;
                                break;
                            }
                        }
                    }
                    if (isValid) {
                        group.forEach(s => validCodes.add(s.seatColumn + s.seatRow));
                    }
                }
            });
            selectedSeats.forEach(code => validCodes.add(code));
            seatsInRow.forEach(seat => {
                const code = seat.seatColumn + seat.seatRow;
                const seatDiv = document.querySelector(`.seat[data-seat="${code}"]`);
                if (!seatDiv) return;
                if (qty === 0 || validCodes.has(code)) {
                    seatDiv.classList.remove("disabled");
                    seatDiv.style.pointerEvents = "auto";
                } else {
                    seatDiv.classList.add("disabled");
                    seatDiv.style.pointerEvents = "none";
                }
            });
        });
        updateCoupleSeatsAvailability();
    }

    function setQuantity(qty) {
        const remaining = MAX_SEATS - selectedSeats.length;
        if (qty > remaining) {
            showPopup(`Ch·ªâ c√≤n ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa ${remaining} gh·∫ø n·ªØa!`);
            return;
        }
        desiredQuantity = qty;
        document.querySelectorAll(".quantity-buttons button").forEach(btn => btn.classList.remove("active-btn"));
        const targetBtn = Array.from(document.querySelectorAll(".quantity-buttons button")).find(btn => btn.textContent.includes(qty + " gh·∫ø"));
        if (targetBtn) targetBtn.classList.add("active-btn");
        showPopup(`Ch·ªçn ${qty} gh·∫ø. Click v√†o 1 gh·∫ø ƒë·ªÉ t·ª± ƒë·ªông ch·ªçn li·ªÅn k·ªÅ.`);
        lockInvalidRows(qty);
        updateQuantityButtons();
        updateCoupleSeatsAvailability();
    }

    function selectSeat(clickedSeatElement, clickedCode) {
        if (desiredQuantity <= 0) {
            showPopup("Vui l√≤ng ch·ªçn s·ªë l∆∞·ª£ng gh·∫ø tr∆∞·ªõc!");
            return;
        }

        const clickedSeat = seatInfoMap[clickedCode];
        if (!clickedSeat || clickedSeat.isBooked || clickedSeat.seatTypeId === 4 || clickedSeat.seatTypeId === 5 || selectedSeats.includes(clickedCode)) return;

        let selectedGroup = [];
        const isCoupleSeat = clickedSeat.seatTypeName?.toLowerCase() === "couple";

        if (isCoupleSeat) {
            const coupleInfo = coupleSeatPairs[clickedCode];
            if (!coupleInfo || !coupleInfo.pairCode) {
                showPopup("Kh√¥ng t√¨m th·∫•y gh·∫ø ƒë√¥i t∆∞∆°ng ·ª©ng!");
                return;
            }

            const pairCode = coupleInfo.pairCode;
            const pairSeat = seatInfoMap[pairCode];

            if (!pairSeat || pairSeat.isBooked || selectedSeats.includes(pairCode)) {
                showPopup("Gh·∫ø ƒë√¥i t∆∞∆°ng ·ª©ng kh√¥ng kh·∫£ d·ª•ng!");
                return;
            }

            if (desiredQuantity !== 2) {
                showPopup("Gh·∫ø ƒë√¥i y√™u c·∫ßu ch·ªçn 2 gh·∫ø!");
                return;
            }

            selectedGroup = [clickedCode, pairCode];
            const container = document.querySelector(`.couple-seat-container[data-seats="${clickedCode},${pairCode}"]`) ||
                document.querySelector(`.couple-seat-container[data-seats="${pairCode},${clickedCode}"]`);
            if (container) {
                container.classList.add("selected");
            }
        } else {
            const row = clickedSeat.seatRow;
            const seatsInRow = seatData.filter(s => s.seatRow === row && !s.isBooked && s.seatTypeId !== 4 && s.seatTypeId !== 5)
                .sort((a, b) => a.seatColumn.charCodeAt(0) - b.seatColumn.charCodeAt(0));
            const colList = seatsInRow.map(s => s.seatColumn);
            const clickedIndex = colList.indexOf(clickedSeat.seatColumn);

            function isValidGroup(group) {
                if (group.length !== desiredQuantity) return false;
                for (let i = 0; i < group.length; i++) {
                    const code = group[i] + row;
                    const seat = seatInfoMap[code];
                    if (!seat || seat.isBooked || seat.seatTypeId === 4 || seat.seatTypeId === 5 || selectedSeats.includes(code)) {
                        return false;
                    }
                    if (seat.seatTypeName?.toLowerCase() === "couple") {
                        return false;
                    }
                    if (i > 0) {
                        const prevChar = group[i - 1].charCodeAt(0);
                        const currChar = group[i].charCodeAt(0);
                        if (currChar !== prevChar + 1) return false;
                        const inBetweenCode = String.fromCharCode(prevChar + 1) + row;
                        if (seatInfoMap[inBetweenCode]?.seatTypeId === 5) return false;
                    }
                }
                return true;
            }

            for (let i = clickedIndex - desiredQuantity + 1; i <= clickedIndex; i++) {
                if (i < 0) continue;
                const group = colList.slice(i, i + desiredQuantity);
                if (isValidGroup(group)) {
                    selectedGroup = group;
                    break;
                }
            }

            if (selectedGroup.length === 0) {
                for (let i = clickedIndex + 1; i <= colList.length - desiredQuantity; i++) {
                    const group = colList.slice(i, i + desiredQuantity);
                    if (isValidGroup(group)) {
                        selectedGroup = group;
                        break;
                    }
                }
            }

            if (selectedGroup.length === 0) {
                showPopup(`Kh√¥ng t√¨m th·∫•y ${desiredQuantity} gh·∫ø li·ªÅn k·ªÅ kh·∫£ d·ª•ng.`);
                return;
            }

            selectedGroup = selectedGroup.map(col => col + row);
        }

        if (selectedSeats.length + selectedGroup.length > MAX_SEATS) {
            showPopup(`B·∫°n ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa ${MAX_SEATS} gh·∫ø!`);
            return;
        }

        selectedGroup.forEach(code => {
            selectedSeats.push(code);
            const seatDiv = document.querySelector(`.seat[data-seat="${code}"]`);
            if (seatDiv) seatDiv.classList.add("selected");
        });

        selectedGroups.set(selectedGroup[0], selectedGroup);
        showPopup(`ƒê√£ ch·ªçn nh√≥m ${selectedGroup.join(", ")}`, true);
        updateSelectionSummary();
        validateSeatSelection();
        updateQuantityButtons();

        if (selectedSeats.length === MAX_SEATS) {
            lockInvalidRows(0);
        } else {
            lockInvalidRows(desiredQuantity);
        }
    }

    function validateSeatSelection() {
        if (selectedSeats.length > 0) {
            const total = selectedSeats.reduce((sum, code) => {
                const seat = seatInfoMap[code];
                const price = seat && seat.seatTypeName?.toLowerCase() === "couple"
                    ? (seat.seatPrice || 0) / 2
                    : (seat.seatPrice || 0);
                return sum + price;
            }, 0);
            checkoutBtn.disabled = false;
            btnText.textContent = "ƒê·∫∑t v√© - " + formatPrice(total);
        } else {
            checkoutBtn.disabled = true;
            btnText.textContent = desiredQuantity === 0 ? "Ch·ªçn s·ªë l∆∞·ª£ng gh·∫ø" : `Ch·ªçn ${desiredQuantity} gh·∫ø`;
        }
    }

    function handleCheckout() {
        if (selectedSeats.length === 0) {
            showPopup("Vui l√≤ng ch·ªçn gh·∫ø!");
            return;
        }
        const total = selectedSeats.reduce((sum, code) => {
            const seat = seatInfoMap[code];
            const price = seat && seat.seatTypeName?.toLowerCase() === "couple"
                ? (seat.seatPrice || 0) / 2
                : (seat.seatPrice || 0);
            return sum + price;
        }, 0);
        const warning = getRatingWarning(ratingCode);
        document.getElementById("ageWarningText").innerText =
            `üé¨ Ph√¢n lo·∫°i ƒë·ªô tu·ªïi: ${warning.name}\n\n${warning.message}`;
        document.getElementById("ageWarningPopup").style.display = "flex";
        document.getElementById("ageWarningPopup").classList.add("show");
        window.heldScheduleSeatIds = selectedSeats.map(code => seatInfoMap[code].scheduleSeatId);
    }

    function generateSeatMap() {
        seatMap.innerHTML = "";
        if (!seatData.length) return;
        const rows = [...new Set(seatData.map(s => s.seatRow))].sort((a, b) => a - b);
        const columns = [...new Set(seatData.map(s => s.seatColumn))].sort();

        const headerRow = document.createElement("div");
        headerRow.classList.add("seat-grid");
        headerRow.style.marginBottom = "6px";
        const emptyCell = document.createElement("div");
        emptyCell.style.width = "40px";
        emptyCell.style.marginRight = "6px";
        headerRow.appendChild(emptyCell);
        columns.forEach(col => {
            const colLabel = document.createElement("div");
            colLabel.textContent = col;
            colLabel.style.width = "40px";
            colLabel.style.textAlign = "center";
            colLabel.style.color = "#ffd700";
            colLabel.style.fontWeight = "bold";
            headerRow.appendChild(colLabel);
        });
        seatMap.appendChild(headerRow);

        rows.forEach(row => {
            const rowDiv = document.createElement("div");
            rowDiv.classList.add("seat-grid");
            rowDiv.style.marginBottom = "6px";
            const rowLabel = document.createElement("div");
            rowLabel.textContent = row;
            rowLabel.style.width = "40px";
            rowLabel.style.textAlign = "center";
            rowLabel.style.color = "#ffd700";
            rowLabel.style.fontWeight = "bold";
            rowLabel.style.marginRight = "6px";
            rowDiv.appendChild(rowLabel);

            const processedCodes = new Set();
            columns.forEach(col => {
                const code = col + row;
                if (processedCodes.has(code)) return;

                const seat = seatInfoMap[code];
                if (!seat) {
                    const seatDiv = document.createElement("div");
                    seatDiv.classList.add("seat", "empty");
                    rowDiv.appendChild(seatDiv);
                    return;
                }

                if (seat.seatTypeId === 4) {
                    const seatDiv = document.createElement("div");
                    seatDiv.classList.add("seat", "empty");
                    seatDiv.style.pointerEvents = "none";
                    rowDiv.appendChild(seatDiv);
                    return;
                }

                if (seat.seatTypeId === 5) {
                    const seatDiv = document.createElement("div");
                    seatDiv.classList.add("seat", "staircase");
                    seatDiv.textContent = "‚áÖ";
                    seatDiv.title = `L·ªëi ƒëi - C·∫ßu thang`;
                    seatDiv.style.pointerEvents = "none";
                    rowDiv.appendChild(seatDiv);
                    return;
                }

                const type = seat.seatTypeName?.toLowerCase();
                if (type === "couple") {
                    const coupleInfo = coupleSeatPairs[code];
                    if (!coupleInfo || !coupleInfo.pairCode || processedCodes.has(coupleInfo.pairCode)) {
                        const seatDiv = document.createElement("div");
                        seatDiv.classList.add("seat", type);
                        seatDiv.setAttribute("data-seat", code);
                        seatDiv.textContent = code;
                        seatDiv.title = `Gh·∫ø ${code} - ${seat.seatTypeName}`;
                        if (seat.isBooked) {
                            seatDiv.classList.add("reserved");
                        } else {
                            seatDiv.addEventListener("click", () => selectSeat(seatDiv, code));
                            seatDiv.addEventListener("contextmenu", handleRightClick(code));
                        }
                        rowDiv.appendChild(seatDiv);
                        return;
                    }

                    const pairCode = coupleInfo.pairCode;
                    processedCodes.add(code);
                    processedCodes.add(pairCode);

                    const container = document.createElement("div");
                    container.classList.add("couple-seat-container");
                    container.setAttribute("data-seats", `${code},${pairCode}`);

                    const seatDiv1 = document.createElement("div");
                    seatDiv1.classList.add("seat", type);
                    seatDiv1.setAttribute("data-seat", code);
                    seatDiv1.textContent = code;
                    seatDiv1.title = `Gh·∫ø ${code} - ${seat.seatTypeName}`;
                    if (seat.isBooked) {
                        seatDiv1.classList.add("reserved");
                    } else {
                        seatDiv1.addEventListener("click", () => selectSeat(seatDiv1, code));
                        seatDiv1.addEventListener("contextmenu", handleRightClick(code));
                    }

                    const pairSeat = seatInfoMap[pairCode];
                    const seatDiv2 = document.createElement("div");
                    seatDiv2.classList.add("seat", type);
                    seatDiv2.setAttribute("data-seat", pairCode);
                    seatDiv2.textContent = pairCode;
                    seatDiv2.title = `Gh·∫ø ${pairCode} - ${pairSeat.seatTypeName}`;
                    if (pairSeat.isBooked) {
                        seatDiv2.classList.add("reserved");
                    } else {
                        seatDiv2.addEventListener("click", () => selectSeat(seatDiv2, pairCode));
                        seatDiv2.addEventListener("contextmenu", handleRightClick(pairCode));
                    }

                    container.appendChild(seatDiv1);
                    container.appendChild(seatDiv2);
                    rowDiv.appendChild(container);
                } else {
                    const seatDiv = document.createElement("div");
                    seatDiv.classList.add("seat", type);
                    seatDiv.setAttribute("data-seat", code);
                    seatDiv.textContent = code;
                    seatDiv.title = `Gh·∫ø ${code} - ${seat.seatTypeName}`;
                    if (seat.isBooked) {
                        seatDiv.classList.add("reserved");
                    } else {
                        seatDiv.addEventListener("click", () => selectSeat(seatDiv, code));
                        seatDiv.addEventListener("contextmenu", handleRightClick(code));
                    }
                    rowDiv.appendChild(seatDiv);
                }
            });
            seatMap.appendChild(rowDiv);
        });

        const legend = document.getElementById("legend");
        legend.innerHTML = "";
        const seatTypes = new Set(seatData
            .filter(seat => seat.seatTypeId !== 4 && seat.seatTypeId !== 5)
            .map(seat => seat.seatTypeName?.toLowerCase()));
        const legendItems = [
            ...Array.from(seatTypes).map(type => ({
                class: type,
                label: type.charAt(0).toUpperCase() + type.slice(1)
            })),
            { class: "selected", label: "ƒê√£ ch·ªçn" },
            { class: "reserved", label: "ƒê√£ ƒë·∫∑t" }
        ];
        legendItems.forEach(item => {
            const legendDiv = document.createElement("div");
            const boxDiv = document.createElement("div");
            boxDiv.classList.add("legend-box", item.class);
            const span = document.createElement("span");
            span.textContent = item.label;
            legendDiv.appendChild(boxDiv);
            legendDiv.appendChild(span);
            legend.appendChild(legendDiv);
        });
        updateQuantityButtons();
        updateCoupleSeatsAvailability();
    }

    function handleRightClick(code) {
        return (event) => {
            event.preventDefault();
            let groupKey = null;
            for (const [key, group] of selectedGroups.entries()) {
                if (group.includes(code)) {
                    groupKey = key;
                    break;
                }
            }
            if (groupKey) {
                const group = selectedGroups.get(groupKey);
                group.forEach(c => {
                    document.querySelector(`.seat[data-seat="${c}"]`)?.classList.remove("selected");
                    const container = document.querySelector(`.couple-seat-container[data-seats*="${c}"]`);
                    if (container) container.classList.remove("selected");
                });
                selectedSeats = selectedSeats.filter(s => !group.includes(s));
                selectedGroups.delete(groupKey);
                showPopup(`B·ªè ch·ªçn nh√≥m gh·∫ø ${group.join(", ")}`);
                updateSelectionSummary();
                validateSeatSelection();
                updateQuantityButtons();
                lockInvalidRows(desiredQuantity);
                updateCoupleSeatsAvailability();
            }
        };
    }

    function updateQuantityButtons() {
        const remaining = MAX_SEATS - selectedSeats.length;
        document.querySelectorAll(".quantity-buttons button").forEach(btn => {
            const qty = parseInt(btn.textContent);
            if (isNaN(qty)) return;
            if (qty > remaining) {
                btn.disabled = true;
                btn.classList.remove("active-btn");
            } else {
                btn.disabled = false;
            }
        });
    }

    function resetSelection() {
        selectedSeats.forEach(code => {
            document.querySelector(`.seat[data-seat="${code}"]`)?.classList.remove("selected");
            const container = document.querySelector(`.couple-seat-container[data-seats*="${code}"]`);
            if (container) container.classList.remove("selected");
        });
        selectedSeats = [];
        selectedGroups.clear();
        desiredQuantity = 0;
        document.querySelectorAll(".quantity-buttons button").forEach(btn => {
            btn.classList.remove("active-btn");
            btn.disabled = false;
        });
        updateSelectionSummary();
        validateSeatSelection();
        lockInvalidRows(0);
        updateQuantityButtons();
        updateCoupleSeatsAvailability();
        showPopup("ƒê√£ reset ch·ªçn gh·∫ø");
    }

    function generatePriceTable() {
        const priceTableBody = document.getElementById("priceTableBody");
        priceTableBody.innerHTML = "";
        const seatTypeDescriptions = {
            normal: "Gh·∫ø ti√™u chu·∫©n, t·∫ßm nh√¨n t·ªët",
            vip: "Gh·∫ø r·ªông r√£i, v·ªã tr√≠ trung t√¢m",
            premium: "Gh·∫ø da cao c·∫•p, c√≥ g√°c ch√¢n",
            couple: "Gh·∫ø ƒë√¥i l√£ng m·∫°n, kh√¥ng tay v·ªãn gi·ªØa"
        };
        const seatTypes = {};
        seatData.forEach(seat => {
            if (seat.seatTypeId !== 4 && seat.seatTypeId !== 5) {
                const typeName = seat.seatTypeName?.toLowerCase();
                if (typeName && !seatTypes[typeName]) {
                    seatTypes[typeName] = {
                        name: seat.seatTypeName,
                        price: seat.seatPrice,
                        class: typeName
                    };
                }
            }
        });
        Object.values(seatTypes).forEach(type => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>
                    <div class="seat-type-indicator">
                        <div class="seat-type-color ${type.class}"></div>
                        ${type.name}
                    </div>
                </td>
                <td class="price-value">${formatPrice(type.price)}</td>
                <td>${seatTypeDescriptions[type.class] || "Kh√¥ng c√≥ m√¥ t·∫£"}</td>
            `;
            priceTableBody.appendChild(row);
        });
    }

    if (resetBtn) {
        resetBtn.addEventListener("click", resetSelection);
    }

    const priceBtn = document.getElementById('priceBtn');
    const pricePopupOverlay = document.getElementById('pricePopupOverlay');
    const pricePopupClose = document.getElementById('pricePopupClose');
    const pricePopup = document.querySelector('.price-popup');
    priceBtn.addEventListener('click', () => {
        document.body.style.overflow = 'hidden';
        pricePopupOverlay.style.display = 'flex';
        pricePopupOverlay.offsetHeight;
        pricePopupOverlay.classList.add('show');
    });

    function closePricePopup() {
        pricePopupOverlay.classList.remove('show');
        setTimeout(() => {
            pricePopupOverlay.style.display = 'none';
            document.body.style.overflow = '';
        }, 400);
    }

    pricePopupClose.addEventListener('click', closePricePopup);
    pricePopupOverlay.addEventListener('click', (e) => {
        if (e.target === pricePopupOverlay) {
            closePricePopup();
        }
    });
    pricePopup.addEventListener('click', (e) => {
        e.stopPropagation();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && pricePopupOverlay.classList.contains('show')) {
            closePricePopup();
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
        generateSeatMap();
        generatePriceTable();
        updateSelectionSummary();
        validateSeatSelection();
        if (checkoutBtn) {
            checkoutBtn.addEventListener("click", handleCheckout);
        }
    });

    const helpIcon = document.getElementById("helpIcon");
    const seatHelp = document.getElementById("seatHelp");
    if (helpIcon && seatHelp) {
        helpIcon.addEventListener("click", (e) => {
            const rect = helpIcon.getBoundingClientRect();
            seatHelp.style.top = (rect.bottom + window.scrollY + 10) + "px";
            seatHelp.style.left = (rect.left + window.scrollX - 20) + "px";
            seatHelp.classList.toggle("show");
        });
        document.addEventListener("click", (e) => {
            if (!seatHelp.contains(e.target) && e.target !== helpIcon) {
                seatHelp.classList.remove("show");
            }
        });
    }

    function getRatingWarning(code) {
        if (code === 'P') {
            return {
                name: "M·ªçi l·ª©a tu·ªïi",
                message: "Phim ph√π h·ª£p v·ªõi m·ªçi l·ª©a tu·ªïi."
            };
        } else if (code === 'K') {
            return {
                name: "Ph√π h·ª£p cho tr·∫ª em",
                message: "Phim ph√π h·ª£p cho tr·∫ª em v√† gia ƒë√¨nh."
            };
        } else if (code === 'T13') {
            return {
                name: "13+",
                message: "Phim d√†nh cho ng∆∞·ªùi t·ª´ 13 tu·ªïi tr·ªü l√™n."
            };
        } else if (code === 'T16') {
            return {
                name: "16+",
                message: "Phim d√†nh cho ng∆∞·ªùi t·ª´ 16 tu·ªïi tr·ªü l√™n."
            };
        } else if (code === 'T18') {
            return {
                name: "18+",
                message: "Phim d√†nh cho ng∆∞·ªùi t·ª´ 18 tu·ªïi tr·ªü l√™n."
            };
        } else {
            return {
                name: "Kh√¥ng x√°c ƒë·ªãnh",
                message: "Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ph√¢n lo·∫°i ƒë·ªô tu·ªïi. Vui l√≤ng ki·ªÉm tra th√¥ng tin phim tr∆∞·ªõc khi ƒë·∫∑t v√©."
            };
        }
    }

    function confirmAgeAgreement() {
        const checkbox = document.getElementById("ageConfirmCheckbox");
        if (!checkbox.checked) {
            alert("B·∫°n c·∫ßn x√°c nh·∫≠n ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu ki·ªán ƒë·ªô tu·ªïi.");
            return;
        }
        document.getElementById("ageWarningPopup").style.display = "none";
        document.getElementById("ageWarningPopup").classList.remove("show");
        const heldScheduleSeatIds = window.heldScheduleSeatIds;
        const movieId = Number(document.getElementById("movieId").value);
        const showtimeId = seatInfoMap[selectedSeats[0]]?.showTimeId;
        const total = selectedSeats.reduce((sum, code) => {
            const seat = seatInfoMap[code];
            const price = seat && seat.seatTypeName?.toLowerCase() === "couple"
                ? (seat.seatPrice || 0) / 2
                : (seat.seatPrice || 0);
            return sum + price;
        }, 0);
        fetch('/seats/hold', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
            },
            body: JSON.stringify({
                scheduleSeatIds: heldScheduleSeatIds,
                movieId: movieId,
                showtimeId: showtimeId
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (data.expireAt) {
                        document.getElementById("expireAtInput").value = data.expireAt;
                    }
                    if (data.invoiceId) {
                        document.getElementById("invoiceId").value = data.invoiceId;
                    }
                    document.getElementById("selectedSeatsInput").value = selectedSeats.join(",");
                    document.getElementById("quantityInput").value = selectedSeats.length;
                    document.getElementById("totalPriceInput").value = total;
                    document.getElementById("seatIdsInput").value = selectedSeats.map(code => seatInfoMap[code].seatId).join(",");
                    document.getElementById("scheduleSeatIdsInput").value = heldScheduleSeatIds.join(",");
                    document.getElementById("showtimeIdInput").value = seatInfoMap[selectedSeats[0]].showTimeId;
                    document.getElementById("bookingForm").submit();
                } else {
                    showPopup("Kh√¥ng th·ªÉ gi·ªØ gh·∫ø: " + data.message);
                }
            })
            .catch(err => {
                console.error("L·ªói gi·ªØ gh·∫ø:", err);
                showPopup("L·ªói h·ªá th·ªëng khi gi·ªØ gh·∫ø!");
            });
    }

    function closeAgePopup() {
        document.getElementById("ageWarningPopup").style.display = "none";
        document.getElementById("ageWarningPopup").classList.remove("show");
    }
</script>
<div th:replace="~{fragments/back-to-top :: back-to-top}"></div>
<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/back-to-top.js}"></script>
<script th:src="@{/js/scroll.js}"></script>
<script th:src="@{/js/chat.js}"></script>
<script th:src="@{/js/chat-widget.js}"></script>
</body>
</html>
