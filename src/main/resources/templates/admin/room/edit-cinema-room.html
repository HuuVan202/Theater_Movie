<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layoutAdmin}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title layout:title-pattern="$CONTENT_TITLE - Cinema Admin">Chỉnh Sửa Phòng Chiếu</title>
    <!-- CSS trang cụ thể -->
    <link rel="stylesheet" th:href="@{/css/admin/crud-room/crud-room.css}">
    <link rel="apple-touch-icon" sizes="180x180" th:href="@{/favicon/apple-touch-icon.png}">
    <link rel="icon" type="image/png" sizes="32x32" th:href="@{/favicon/favicon-32x32.png}">
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/favicon/favicon-16x16.png}">
    <link rel="manifest" th:href="@{/favicon/site.webmanifest}">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon/favicon.ico}">
    <style>
        #page-content-wrapper {
            max-height: 100vh;
            overflow-y: auto;
        }
    </style>
</head>

<body>
<!-- Header Fragment -->
<div layout:fragment="header">
    <nav class="navbar navbar-expand-lg navbar-light bg-danger shadow-sm px-3">
        <div class="container-fluid px-0">
            <span class="navbar-brand text-white fw-bold"><i class="bi bi-door-open me-2"></i>Sửa phòng chiếu</span>
        </div>
    </nav>
</div>

<!-- Content Fragment -->
<main layout:fragment="content" class="container-fluid py-4">
    <div class="user-table-wrapper p-3 p-md-4 rounded-4 shadow-lg animate-fade-in">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <h3 class="fw-bold mb-0">Thông tin phòng chiếu</h3>
            <a th:href="@{/admin/cinema-room}" class="btn btn-secondary btn-sm"><i class="bi bi-arrow-left"></i> Quay lại</a>
        </div>

        <div th:if="${error != null}" class="alert alert-danger">
            <p th:text="${error}"></p>
        </div>

        <form th:action="@{/admin/cinema-room/update-seat-map}" method="post" th:object="${cinemaRoomDTO}" id="editForm" class="row g-3">
            <input type="hidden" th:field="*{roomId}" />

            <div class="col-md-6">
                <label for="roomName" class="form-label">Tên phòng:</label>
                <input type="text" th:field="*{roomName}" id="roomName" class="form-control" required/>
                <span th:if="${#fields.hasErrors('roomName')}" th:errors="*{roomName}" class="error"></span>
            </div>

            <div class="col-md-6">
                <label for="type" class="form-label">Loại phòng:</label>
                <select th:field="*{type}" id="type" class="form-select" required>
                    <option th:each="roomType : ${roomTypes}" th:value="${roomType}" th:text="${roomType}"></option>
                </select>
                <span th:if="${#fields.hasErrors('type')}" th:errors="*{type}" class="error"></span>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Trạng thái:</label>
                <div class="d-flex gap-4">
                    <div class="form-check">
                        <input type="radio" th:field="*{status}" id="statusInactive" value="0" required class="form-check-input"/>
                        <label for="statusInactive" class="form-check-label">Không hoạt động</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" th:field="*{status}" id="statusActive" value="1" class="form-check-input"/>
                        <label for="statusActive" class="form-check-label">Hoạt động</label>
                    </div>
                </div>
                <span th:if="${#fields.hasErrors('status')}" th:errors="*{status}" class="error"></span>
            </div>

            <div class="col-md-6 mb-3">
                <label for="seatQuantity" class="form-label">Số lượng ghế:</label>
                <input type="number" th:field="*{seatQuantity}" id="seatQuantity" class="form-control" readonly/>
                <span th:if="${#fields.hasErrors('seatQuantity')}" th:errors="*{seatQuantity}" class="error"></span>
            </div>

            <div class="col-md-6">
                <label for="rows" class="form-label">Số hàng ghế:</label>
                <input type="number" th:field="*{seatMap.rows}" id="rows" min="1" required class="form-control"/>
                <span th:if="${#fields.hasErrors('seatMap.rows')}" th:errors="*{seatMap.rows}" class="error"></span>
            </div>

            <div class="col-md-6">
                <label for="cols" class="form-label">Số cột ghế:</label>
                <input type="number" th:field="*{seatMap.cols}" id="cols" min="1" required class="form-control"/>
                <span th:if="${#fields.hasErrors('seatMap.cols')}" th:errors="*{seatMap.cols}" class="error"></span>
            </div>

            <div class="col-md-6 mb-3" style="display: none;">
                <label for="staircaseCols" class="form-label">Cột cầu thang (vd: 1,3):</label>
                <input type="text" class="form-control" th:field="*{seatMap.staircaseColumns}" id="staircaseCols" placeholder="Nhập số cột cách nhau bởi dấu phẩy">
                <small id="staircaseColsError" class="text-danger"></small>
            </div>

            <div class="col-12 mt-4">
                <div class="instructions">
                    <h5><i class="bi bi-info-circle me-2"></i>Hướng dẫn chỉnh sửa sơ đồ phòng</h5>
                    <ul>
                        <li><strong>Thay đổi loại ghế đơn:</strong>
                            <ul>
                                <li>Click thường: Chuyển đổi giữa ghế thường (Normal) và ghế VIP</li>
                                <li>Click chuột phải: Chuyển đổi giữa ghế trống (Empty) và ghế thường</li>
                                <li>Click + phím Ctrl: Tạo ghế đôi (áp dụng cho hai ghế liền nhau)</li>
                            </ul>
                        </li>
                        <li><strong>Thay đổi cả hàng:</strong> Sử dụng các nút bên phải mỗi hàng để đổi toàn bộ hàng thành một loại ghế</li>
                        <li><strong>Cột cầu thang:</strong> Nhấp vào các nút "Cột X" phía dưới để đánh dấu/bỏ đánh dấu cột làm lối đi</li>
                        <li><strong>Thay đổi kích thước:</strong> Thay đổi số hàng/cột và hệ thống sẽ tự động điều chỉnh</li>
                        <li><strong>Lưu ý:</strong> Hệ thống sẽ tự động tính tổng số ghế và hiển thị cảnh báo nếu không phù hợp với loại phòng</li>
                    </ul>
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-2"></i>
                        <strong>Mẹo:</strong> Loại phòng khác nhau có khuyến nghị số ghế khác nhau. 2D: 120-250 ghế, 3D: 100-200 ghế, IMAX: 300-450 ghế, 4DX: 80-120 ghế.
                    </div>
                </div>
            </div>

            <div class="col-12">
                <label class="form-label fw-bold">Sơ đồ ghế:</label>
                <div class="card p-3">
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-seat seat-normal"></div>
                            <span>Ghế thường</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat seat-vip"></div>
                            <span>Ghế VIP</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat seat-couple"></div>
                            <span>Ghế đôi</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat seat-staircase"></div>
                            <span>Cầu thang</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-seat seat-empty"></div>
                            <span>Trống</span>
                        </div>
                    </div>

                    <div class="seat-container">
                        <div class="screen">
                            <i class="bi bi-display me-2"></i>MÀN HÌNH
                        </div>
                        <div id="seatLayout" class="seat-layout"></div>
                    </div>

                    <div class="staircase-controls">
                        <strong>Chọn cột cầu thang:</strong>
                        <div id="staircaseToggles" class="staircase-toggles"></div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <span id="countNormal" class="stat-number text-info">0</span>
                        <span class="stat-label">Ghế thường</span>
                    </div>
                    <div class="stat-item">
                        <span id="countVIP" class="stat-number text-warning">0</span>
                        <span class="stat-label">Ghế VIP</span>
                    </div>
                    <div class="stat-item">
                        <span id="countCouple" class="stat-number text-danger">0</span>
                        <span class="stat-label">Ghế đôi</span>
                    </div>
                    <div class="stat-item">
                        <span id="countStaircase" class="stat-number text-secondary">0</span>
                        <span class="stat-label">Cầu thang</span>
                    </div>
                    <div class="stat-item">
                        <span id="countEmpty" class="stat-number text-muted">0</span>
                        <span class="stat-label">Trống</span>
                    </div>
                </div>
            </div>

            <div class="col-12 mt-4">
                <label class="form-label fw-bold">Giá ghế theo loại (VND):</label>
                <div id="priceFields" class="row"></div>
            </div>

            <div class="col-12 mt-4">
                <button type="submit" class="btn btn-success"><i class="bi bi-check-circle"></i> Lưu phòng chiếu</button>
                <a th:href="@{/admin/cinema-room}" class="btn btn-secondary"><i class="bi bi-x-circle"></i> Hủy</a>
            </div>
        </form>
    </div>

    <!-- Hidden data for JavaScript -->
    <script th:inline="javascript">
        window.initialSeatData = {
            rows: /*[[${cinemaRoomDTO.seatMap.rows}]]*/ 0,
            cols: /*[[${cinemaRoomDTO.seatMap.cols}]]*/ 0,
            staircaseColumns: /*[[${cinemaRoomDTO.seatMap.staircaseColumns}]]*/ '',
            seatTypes: /*[[${cinemaRoomDTO.seatMap.seatTypes}]]*/ [],
            seatPrices: /*[[${cinemaRoomDTO.seatPrices}]]*/ {}
        };
    </script>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rowsInput = document.getElementById('rows');
            const colsInput = document.getElementById('cols');
            const seatLayout = document.getElementById('seatLayout');
            const seatQuantityInput = document.getElementById('seatQuantity');
            const staircaseColsInput = document.getElementById('staircaseCols');
            const staircaseColsError = document.getElementById('staircaseColsError');
            const staircaseToggles = document.getElementById('staircaseToggles');
            const form = document.getElementById('editForm');
            const typeSelect = document.getElementById('type');
            const priceFields = document.getElementById('priceFields');

            // Configuration for room types
            const ROOM_TYPE_CONFIG = {
                '2D': {min: 120, max: 250, default: 120},
                '3D': {min: 100, max: 200, default: 100},
                'IMAX': {min: 300, max: 450, default: 300},
                '4DX': {min: 80, max: 120, default: 80}
            };

            // Seat state management
            let seatData = [];
            let staircaseColumns = new Set();

            const init = window.initialSeatData;

            // Warning div for seat quantity
            const warningDiv = document.createElement('div');
            warningDiv.className = 'text-warning mt-2';
            seatQuantityInput.parentElement.appendChild(warningDiv);

            function generateColumnLabels(cols) {
                const labels = [];
                for (let i = 0; i < cols; i++) {
                    if (i < 26) {
                        labels.push(String.fromCharCode(65 + i)); // A, B, C...
                    } else {
                        labels.push(String.fromCharCode(65 + Math.floor(i / 26) - 1) + String.fromCharCode(65 + (i % 26))); // AA, AB...
                    }
                }
                return labels;
            }

            // Khởi tạo dữ liệu cầu thang và seatData từ dữ liệu ban đầu
            function loadStaircaseColumns() {
                staircaseColumns.clear();
                const staircaseCols = (init.staircaseColumns || staircaseColsInput.value || '')
                    .split(',')
                    .map(s => parseInt(s.trim()) - 1)
                    .filter(c => !isNaN(c) && c >= 0);

                staircaseCols.forEach(col => staircaseColumns.add(col));
            }

            function initializeSeatData() {
                const rows = parseInt(rowsInput.value) || 1;
                const cols = parseInt(colsInput.value) || 1;

                // Initialize with existing data
                seatData = Array(rows).fill().map(() => Array(cols).fill('Normal'));

                // Load existing data from backend
                for (let i = 0; i < init.rows; i++) {
                    for (let j = 0; j < init.cols; j++) {
                        if (i < rows && j < cols) {
                            const value = (init.seatTypes[i] || [])[j];
                            if (value) seatData[i][j] = value;
                        }
                    }
                }

                // Mark staircase columns
                staircaseColumns.forEach(col => {
                    if (col < cols) {
                        for (let row = 0; row < rows; row++) {
                            seatData[row][col] = 'Staircase';
                        }
                    }
                });
            }

            function generateSeatGrid() {
                const rows = parseInt(rowsInput.value) || 1;
                const cols = parseInt(colsInput.value) || 1;

                if (rows > 20 || cols > 30) {
                    alert('Số hàng tối đa 20, số cột tối đa 30');
                    return;
                }

                // Initialize seat data
                initializeSeatData();

                // Clear previous grid
                seatLayout.innerHTML = '';

                // Generate column headers
                const colHeader = document.createElement('div');
                colHeader.className = 'col-header';
                const columnLabels = generateColumnLabels(cols);

                columnLabels.forEach(label => {
                    const colLabel = document.createElement('div');
                    colLabel.className = 'col-label';
                    colLabel.textContent = label;
                    colHeader.appendChild(colLabel);
                });
                seatLayout.appendChild(colHeader);

                // Generate seat rows
                for (let i = 0; i < rows; i++) {
                    const seatRow = document.createElement('div');
                    seatRow.className = 'seat-row';

                    // Row label
                    const rowLabel = document.createElement('div');
                    rowLabel.className = 'row-label';
                    rowLabel.textContent = i + 1;
                    seatRow.appendChild(rowLabel);

                    // Seat grid for this row
                    const seatGrid = document.createElement('div');
                    seatGrid.className = 'seat-grid';

                    for (let j = 0; j < cols; j++) {
                        const seat = document.createElement('div');
                        seat.className = `seat seat-${seatData[i][j].toLowerCase()}`;
                        seat.dataset.row = i;
                        seat.dataset.col = j;

                        // Hidden input for form submission
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = `seatMap.seatTypes[${i}][${j}]`;
                        hiddenInput.value = seatData[i][j];
                        seat.appendChild(hiddenInput);

                        // Event listeners
                        seat.addEventListener('click', handleSeatClick);
                        seat.addEventListener('contextmenu', handleSeatRightClick);

                        seatGrid.appendChild(seat);
                    }
                    seatRow.appendChild(seatGrid);

                    // Row controls
                    const rowControls = document.createElement('div');
                    rowControls.className = 'row-controls';

                    const normalBtn = document.createElement('button');
                    normalBtn.type = 'button';
                    normalBtn.className = 'row-control-btn btn-normal';
                    normalBtn.textContent = 'Thường';
                    normalBtn.onclick = () => setRowType(i, 'Normal');

                    const vipBtn = document.createElement('button');
                    vipBtn.type = 'button';
                    vipBtn.className = 'row-control-btn btn-vip';
                    vipBtn.textContent = 'VIP';
                    vipBtn.onclick = () => setRowType(i, 'VIP');

                    const coupleBtn = document.createElement('button');
                    coupleBtn.type = 'button';
                    coupleBtn.className = 'row-control-btn btn-couple';
                    coupleBtn.textContent = 'Đôi';
                    coupleBtn.onclick = () => setRowType(i, 'Couple');

                    rowControls.appendChild(normalBtn);
                    rowControls.appendChild(vipBtn);
                    rowControls.appendChild(coupleBtn);
                    seatRow.appendChild(rowControls);

                    seatLayout.appendChild(seatRow);
                }

                generateStaircaseToggles();
                updateSeatQuantity();
                generatePriceFields();
            }

            function generateStaircaseToggles() {
                const cols = parseInt(colsInput.value) || 1;
                staircaseToggles.innerHTML = '';

                const columnLabels = generateColumnLabels(cols);

                for (let i = 0; i < cols; i++) {
                    const toggle = document.createElement('div');
                    toggle.className = 'staircase-toggle';
                    toggle.textContent = `Cột ${columnLabels[i]}`;
                    toggle.dataset.col = i;

                    // Check if this column is a staircase column and set active class
                    if (staircaseColumns.has(i)) {
                        toggle.classList.add('active');
                    }

                    toggle.addEventListener('click', () => {
                        if (staircaseColumns.has(i)) {
                            staircaseColumns.delete(i);
                            toggle.classList.remove('active');
                            // Reset column to normal seats
                            resetColumnSeats(i);
                        } else {
                            staircaseColumns.add(i);
                            toggle.classList.add('active');
                            // Set column as staircase
                            setColumnStaircase(i);
                        }
                        updateSeatDisplay();
                    });

                    staircaseToggles.appendChild(toggle);
                }
            }

            function handleSeatClick(e) {
                if (e.ctrlKey) {
                    handleCtrlClick(e);
                } else {
                    handleNormalClick(e);
                }
            }

            function handleCtrlClick(e) {
                const seat = e.target;
                const row = parseInt(seat.dataset.row);
                const col = parseInt(seat.dataset.col);
                const cols = parseInt(colsInput.value) || 1;

                if (staircaseColumns.has(col)) return; // Cannot change staircase seats

                // Kiểm tra nếu ghế hiện tại là ghế đôi -> chuyển về ghế thường
                if (seatData[row][col] === 'Couple') {
                    // Xác định ghế cặp đôi (ghế liền kề trong cặp đôi)
                    let pairCol;

                    // Tìm ghế đôi liền kề (kiểm tra cả bên trái và bên phải)
                    if (col + 1 < cols && seatData[row][col + 1] === 'Couple') {
                        pairCol = col + 1;
                    } else if (col - 1 >= 0 && seatData[row][col - 1] === 'Couple') {
                        pairCol = col - 1;
                    }

                    // Chuyển cả hai ghế thành Normal
                    if (pairCol !== undefined) {
                        seatData[row][col] = 'Normal';
                        seatData[row][pairCol] = 'Normal';
                    } else {
                        seatData[row][col] = 'Normal'; // Chỉ chuyển ghế này nếu không tìm thấy cặp
                    }
                    updateSeatDisplay();
                    return;
                }

                // Hành vi tạo ghế đôi
                // Xác định vị trí ghế cặp đôi phù hợp nhất dựa trên vị trí cột
                let pairCol = -1;

                // Chiến lược chọn ghế cặp đôi trong trường hợp có cầu thang hoặc 3 ghế liền nhau
                if (col % 2 === 0) {
                    // Nếu là cột chẵn, ưu tiên ghép với cột bên phải
                    if (col + 1 < cols && !staircaseColumns.has(col + 1) && seatData[row][col + 1] !== 'Couple') {
                        pairCol = col + 1;
                    }
                    // Nếu không thể ghép phải, kiểm tra cột bên trái
                    else if (col - 1 >= 0 && !staircaseColumns.has(col - 1) && seatData[row][col - 1] !== 'Couple') {
                        pairCol = col - 1;
                    }
                } else {
                    // Nếu là cột lẻ, ưu tiên ghép với cột bên trái
                    if (col - 1 >= 0 && !staircaseColumns.has(col - 1) && seatData[row][col - 1] !== 'Couple') {
                        pairCol = col - 1;
                    }
                    // Nếu không thể ghép trái, kiểm tra cột bên phải
                    else if (col + 1 < cols && !staircaseColumns.has(col + 1) && seatData[row][col + 1] !== 'Couple') {
                        pairCol = col + 1;
                    }
                }

                // Kiểm tra xem ghế cặp đôi có tồn tại và hợp lệ không
                if (pairCol >= 0 && pairCol < cols) {
                    // Không biến ghế cầu thang thành ghế đôi
                    if (seatData[row][col] !== 'Staircase' && seatData[row][pairCol] !== 'Staircase') {
                        // Chỉ chuyển đổi ghế thường hoặc VIP thành ghế đôi
                        if ((seatData[row][col] === 'Normal' || seatData[row][col] === 'VIP') &&
                            (seatData[row][pairCol] === 'Normal' || seatData[row][pairCol] === 'VIP')) {
                            seatData[row][col] = 'Couple';
                            seatData[row][pairCol] = 'Couple';
                            updateSeatDisplay();
                        }
                    }
                }
            }

            function handleNormalClick(e) {
                const seat = e.target;
                const row = parseInt(seat.dataset.row);
                const col = parseInt(seat.dataset.col);

                if (staircaseColumns.has(col)) return; // Cannot change staircase seats

                const currentType = seatData[row][col];
                let newType;

                if (currentType === 'Normal') {
                    newType = 'VIP';
                } else if (currentType === 'VIP') {
                    newType = 'Normal';
                } else {
                    return; // Don't change couple or empty seats with normal click
                }

                seatData[row][col] = newType;
                updateSeatDisplay();
            }

            function handleSeatRightClick(e) {
                e.preventDefault();
                const seat = e.target;
                const row = parseInt(seat.dataset.row);
                const col = parseInt(seat.dataset.col);

                if (staircaseColumns.has(col)) return; // Cannot change staircase seats

                // Hành vi gốc cho right-click thông thường (chuyển đổi giữa Empty và Normal)
                const currentType = seatData[row][col];
                const newType = (currentType === 'Empty') ? 'Normal' : 'Empty';
                seatData[row][col] = newType;

                updateSeatDisplay();
            }

            function setRowType(row, type) {
                const cols = parseInt(colsInput.value) || 1;

                if (type === 'Couple') {
                    // Check if row has even number of non-staircase seats
                    let availableSeats = 0;
                    for (let j = 0; j < cols; j++) {
                        if (!staircaseColumns.has(j)) {
                            availableSeats++;
                        }
                    }

                    if (availableSeats % 2 !== 0) {
                        alert('Không thể tạo ghế đôi cho hàng có số ghế lẻ!');
                        return;
                    }
                }

                // Set type for all non-staircase seats in the row
                for (let j = 0; j < cols; j++) {
                    if (!staircaseColumns.has(j)) {
                        seatData[row][j] = type;
                    }
                }

                updateSeatDisplay();
            }

            function resetColumnSeats(col) {
                const rows = parseInt(rowsInput.value) || 1;
                for (let i = 0; i < rows; i++) {
                    seatData[i][col] = 'Normal';
                }
                // Update the staircaseColsInput with the new staircase columns
                updateStaircaseColsInput();
            }

            function setColumnStaircase(col) {
                const rows = parseInt(rowsInput.value) || 1;
                for (let i = 0; i < rows; i++) {
                    seatData[i][col] = 'Staircase';
                }
                // Update the staircaseColsInput with the new staircase columns
                updateStaircaseColsInput();
            }

            function updateStaircaseColsInput() {
                // Convert Set to sorted array and add 1 to make it 1-based indexing
                const columnsArray = Array.from(staircaseColumns).map(col => col + 1).sort((a, b) => a - b);
                staircaseColsInput.value = columnsArray.join(',');
            }

            function updateSeatDisplay() {
                const rows = parseInt(rowsInput.value) || 1;
                const cols = parseInt(colsInput.value) || 1;

                // Cập nhật trạng thái visual của ghế
                for (let i = 0; i < rows; i++) {
                    for (let j = 0; j < cols; j++) {
                        const seat = document.querySelector(`.seat[data-row="${i}"][data-col="${j}"]`);
                        if (seat) {
                            // Xóa tất cả các class liên quan đến loại ghế
                            seat.classList.remove('seat-normal', 'seat-vip', 'seat-couple', 'seat-staircase', 'seat-empty');

                            // Thêm class mới dựa vào loại ghế trong seatData
                            seat.classList.add(`seat-${seatData[i][j].toLowerCase()}`);

                            // Cập nhật giá trị input ẩn
                            const hiddenInput = seat.querySelector('input');
                            if (hiddenInput) {
                                hiddenInput.value = seatData[i][j];
                            }
                        }
                    }
                }

                updateSeatQuantity();
                generatePriceFields();
            }

            function updateSeatQuantity() {
                let countNormal = 0;
                let countVIP = 0;
                let countCouple = 0;
                let countStaircase = 0;
                let countEmpty = 0;

                for (let i = 0; i < seatData.length; i++) {
                    for (let j = 0; j < seatData[i].length; j++) {
                        switch (seatData[i][j]) {
                            case 'Normal':
                                countNormal++;
                                break;
                            case 'VIP':
                                countVIP++;
                                break;
                            case 'Couple':
                                countCouple++;
                                break;
                            case 'Staircase':
                                countStaircase++;
                                break;
                            case 'Empty':
                                countEmpty++;
                                break;
                        }
                    }
                }

                // Cập nhật thống kê ghế
                document.getElementById('countNormal').textContent = countNormal;
                document.getElementById('countVIP').textContent = countVIP;
                document.getElementById('countCouple').textContent = countCouple;
                document.getElementById('countStaircase').textContent = countStaircase;
                document.getElementById('countEmpty').textContent = countEmpty;

                // Cập nhật tổng số ghế
                const totalSeats = countNormal + countVIP + countCouple;
                seatQuantityInput.value = totalSeats;

                // Kiểm tra khuyến nghị số ghế
                const type = typeSelect.value;
                const config = ROOM_TYPE_CONFIG[type];
                if (config && (totalSeats < config.min || totalSeats > config.max)) {
                    warningDiv.innerHTML = `⚠️ Khuyến nghị số ghế cho phòng ${type} là từ ${config.min} đến ${config.max} ghế.`;
                } else {
                    warningDiv.innerHTML = '';
                }
            }

            function generatePriceFields() {
                const priceFieldsDiv = document.getElementById('priceFields');
                priceFieldsDiv.innerHTML = '';

                // Lấy các loại ghế duy nhất từ seatData (chỉ lấy Normal, VIP, Couple)
                const uniqueSeatTypes = [...new Set(seatData.flat())].filter(type => ['Normal', 'VIP', 'Couple'].includes(type));

                // Mapping tên loại ghế từ JavaScript sang tên key trong backend
                const typeMapping = {
                    'Normal': 'normal',
                    'VIP': 'vip',
                    'Couple': 'couple'
                };

                // Mapping tên hiển thị
                const displayNames = {
                    'Normal': 'Ghế thường (Normal)',
                    'VIP': 'Ghế VIP',
                    'Couple': 'Ghế đôi (Couple)'
                };

                uniqueSeatTypes.forEach(type => {
                    const div = document.createElement('div');
                    div.className = 'col-md-4 mb-3';

                    const label = document.createElement('label');
                    label.className = 'form-label';
                    label.textContent = `${displayNames[type]}:`;

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'form-control';
                    input.name = `seatPrices[${typeMapping[type]}]`;
                    input.min = '0';
                    input.step = '1000';
                    input.required = true;

                    // Lấy giá trị từ backend nếu có, nếu không thì dùng giá trị mặc định
                    const backendKey = typeMapping[type];
                    const existingPrice = init.seatPrices[backendKey];

                    if (existingPrice) {
                        input.value = existingPrice;
                    } else {
                        // Giá trị mặc định nếu chưa có
                        const defaultPrices = {
                            'normal': 100000,
                            'vip': 150000,
                            'couple': 200000
                        };
                        input.value = defaultPrices[backendKey] || 0;
                    }

                    // Thêm span để hiển thị lỗi
                    const errorSpan = document.createElement('span');
                    errorSpan.className = 'error text-danger';

                    div.appendChild(label);
                    div.appendChild(input);
                    div.appendChild(errorSpan);
                    priceFieldsDiv.appendChild(div);
                });
            }

            // Thêm validation client-side trước khi submit
            form.addEventListener('submit', (e) => {
                const inputs = priceFields.querySelectorAll('input[name^="seatPrices"]');
                let isValid = true;

                inputs.forEach(input => {
                    if (!input.value.trim() || parseFloat(input.value) < 0) {
                        isValid = false;
                        input.classList.add('is-invalid');
                        input.nextElementSibling.textContent = 'Giá phải lớn hơn hoặc bằng 0 và không được để trống';
                    } else {
                        input.classList.remove('is-invalid');
                        input.nextElementSibling.textContent = '';
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    alert('Vui lòng nhập giá hợp lệ cho tất cả các loại ghế!');
                }
            });

            // Event handlers for input changes
            rowsInput.addEventListener('change', () => {
                generateSeatGrid();
            });

            colsInput.addEventListener('change', () => {
                generateSeatGrid();
            });

            staircaseColsInput.addEventListener('input', () => {
                loadStaircaseColumns();
                generateSeatGrid();
            });

            form.addEventListener('submit', () => {
                updateSeatQuantity();
            });

            typeSelect.addEventListener('change', () => {
                updateSeatQuantity();
            });

            // Initialize the grid when page loads
            loadStaircaseColumns();
            generateSeatGrid();
        });
    </script>
</main>
</body>
</html>