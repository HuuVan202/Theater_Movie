<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layoutAdmin}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title layout:title-pattern="$CONTENT_TITLE - Cinema Admin">Tạo Khuyến mãi</title>
    <link rel="stylesheet" th:href="@{/css/adminPromotion.css}">
    <link rel="apple-touch-icon" sizes="180x180" th:href="@{/favicon/apple-touch-icon.png}">
    <link rel="icon" type="image/png" sizes="32x32" th:href="@{/favicon/favicon-32x32.png}">
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/favicon/favicon-16x16.png}">
    <link rel="manifest" th:href="@{/favicon/site.webmanifest}">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon/favicon.ico}">
    <style>
        .datetime-local {
            cursor: pointer;
        }
    </style>
</head>
<body>
<!-- Header Fragment -->
<div layout:fragment="header">
    <nav class="navbar navbar-expand-lg navbar-light bg-danger shadow-sm px-2">
        <div class="container-fluid px-0">
            <span class="navbar-brand text-white fw-bold"><i class="bi bi-gift me-2"></i>Tạo khuyến mãi</span>
        </div>
    </nav>
</div>

<!-- Content Fragment -->
<main layout:fragment="content" class="container-fluid py-3">
    <div class="user-table-wrapper p-3 rounded-4 shadow-lg animate-fade-in">
        <h3 class="fw-bold mb-3">Tạo khuyến mãi mới</h3>
        <form th:action="@{/admin/promotions/create}" th:object="${promotion}" method="post" enctype="multipart/form-data" class="row g-3" id="createPromotionForm">
            <div class="col-md-6">
                <label class="form-label" for="titleInput">Tiêu đề</label>
                <input type="text" th:field="*{title}" class="form-control" id="titleInput" aria-describedby="titleError" />
                <div class="error-message" th:if="${#fields.hasErrors('title')}" th:errors="*{title}" id="titleError"></div>
            </div>
            <div class="col-md-6">
                <label class="form-label" for="detailInput">Chi tiết</label>
                <textarea th:field="*{detail}" class="form-control" id="detailInput" style="height: 80px" aria-describedby="detailError"></textarea>
                <div class="error-message" th:if="${#fields.hasErrors('detail')}" th:errors="*{detail}" id="detailError"></div>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="movieSelect">Phim áp dụng</label>
                <select th:field="*{movieId}" class="form-select" id="movieSelect" aria-describedby="movieError">
                    <option value="">Tất cả phim</option>
                    <option th:each="movie : ${movies}" th:value="${movie.movieId}" th:text="${movie.movieName}"></option>
                </select>
                <div class="error-message" th:if="${#fields.hasErrors('movieId')}" th:errors="*{movieId}" id="movieError"></div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Loại giảm giá</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="discountType" id="discountLevelRadio" value="percentage" th:checked="${promotion.discountLevel != null}">
                    <label class="form-check-label" for="discountLevelRadio">Giảm giá (%)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="discountType" id="discountAmountRadio" value="fixed" th:checked="${promotion.discountAmount != null}">
                    <label class="form-check-label" for="discountAmountRadio">Giảm giá cố định (VND)</label>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-2" id="discountLevelField" style="display: none;">
                    <label class="form-label" for="discountLevelInput">Giảm giá (%)</label>
                    <input type="number" step="0.01" th:field="*{discountLevel}" class="form-control" id="discountLevelInput" aria-describedby="discountLevelError" />
                    <div class="error-message" th:if="${#fields.hasErrors('discountLevel')}" th:errors="*{discountLevel}" id="discountLevelError"></div>
                </div>
                <div class="mb-2" id="discountAmountField" style="display: none;">
                    <label class="form-label" for="discountAmountInput">Giảm giá cố định (VND)</label>
                    <input type="number" step="0.01" th:field="*{discountAmount}" class="form-control" id="discountAmountInput" aria-describedby="discountAmountError" />
                    <div class="error-message" th:if="${#fields.hasErrors('discountAmount')}" th:errors="*{discountAmount}" id="discountAmountError"></div>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="minTicketsInput">Số vé tối thiểu</label>
                <input type="number" th:field="*{minTickets}" class="form-control" id="minTicketsInput" aria-describedby="minTicketsError" />
                <div class="error-message" th:if="${#fields.hasErrors('minTickets')}" th:errors="*{minTickets}" id="minTicketsError"></div>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="maxTicketsInput">Số vé tối đa</label>
                <input type="number" th:field="*{maxTickets}" class="form-control" id="maxTicketsInput" aria-describedby="maxTicketsError" />
                <div class="error-message" th:if="${#fields.hasErrors('maxTickets')}" th:errors="*{maxTickets}" id="maxTicketsError"></div>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="dayOfWeekSelect">Ngày áp dụng</label>
                <select th:field="*{dayOfWeek}" class="form-select" id="dayOfWeekSelect" aria-describedby="dayOfWeekError">
                    <option value="">Tất cả các ngày</option>
                    <option value="1">Thứ 2</option>
                    <option value="2">Thứ 3</option>
                    <option value="3">Thứ 4</option>
                    <option value="4">Thứ 5</option>
                    <option value="5">Thứ 6</option>
                    <option value="6">Thứ 7</option>
                    <option value="7">Chủ nhật</option>
                </select>
                <div class="error-message" th:if="${#fields.hasErrors('dayOfWeek')}" th:errors="*{dayOfWeek}" id="dayOfWeekError"></div>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="ticketTypeSelect">Loại vé</label>
                <select th:field="*{ticketTypeId}" class="form-select" id="ticketTypeSelect" aria-describedby="ticketTypeError">
                    <option value="">Tất cả loại vé</option>
                    <option th:each="ticketType : ${ticketTypes}" th:value="${ticketType.ticketTypeId}" th:text="${ticketType.typeName}"></option>
                </select>
                <div class="error-message" th:if="${#fields.hasErrors('ticketTypeId')}" th:errors="*{ticketTypeId}" id="ticketTypeError"></div>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="startTimeInput">Bắt đầu</label>
                <input type="datetime-local" th:field="*{startTime}" id="startTimeInput" class="form-control datetime-local" step="60" aria-describedby="startTimeError" />
                <div class="error-message" th:if="${#fields.hasErrors('startTime')}" th:errors="*{startTime}" id="startTimeError"></div>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="endTimeInput">Kết thúc</label>
                <input type="datetime-local" th:field="*{endTime}" id="endTimeInput" class="form-control datetime-local" step="60" aria-describedby="endTimeError" />
                <div class="error-message" th:if="${#fields.hasErrors('endTime')}" th:errors="*{endTime}" id="endTimeError"></div>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="maxUsageInput">Giới hạn sử dụng</label>
                <input type="number" th:field="*{maxUsage}" class="form-control" id="maxUsageInput" aria-describedby="maxUsageError" />
                <div class="error-message" th:if="${#fields.hasErrors('maxUsage')}" th:errors="*{maxUsage}" id="maxUsageError"></div>
            </div>
            <div class="col-md-6">
                <label class="form-label" for="imageUrlInput">Hình ảnh khuyến mãi</label>
                <div class="image-section mb-2">
                    <div class="image-preview-wrapper">
                        <img th:if="${promotion.imageUrl != null and not #strings.isEmpty(promotion.imageUrl)}" th:src="@{${promotion.imageUrl}}" id="imagePreview" alt="Hình ảnh hiện tại" class="img-fluid rounded shadow-sm" style="display: block;" />
                    </div>
                    <div class="image-inputs">
                        <input type="text" th:field="*{imageUrl}" class="form-control mb-2" id="imageUrlInput" placeholder="Nhập URL ảnh (hoặc chọn file bên dưới)" aria-describedby="imageUrlError" oninput="handleImageInputChange()" />
                        <input type="file" name="imageFile" id="imageFileInput" class="form-control" accept="image/*" onchange="handleImageFileChange()" />
                    </div>
                </div>
                <div class="error-message" th:if="${#fields.hasErrors('imageUrl')}" th:errors="*{imageUrl}" id="imageUrlError"></div>
            </div>
            <div class="col-md-6 d-flex align-items-center">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" th:field="*{active}" id="activeCheck" />
                    <label class="form-check-label ms-2" for="activeCheck">Hoạt động</label>
                </div>
            </div>
            <div class="col-12 text-center mt-3">
                <button type="submit" class="btn btn-gradient btn-sm me-2" id="submitButton"><i class="bi bi-plus-circle"></i> Tạo khuyến mãi</button>
                <a th:href="@{/admin/promotions/list}" class="btn btn-secondary btn-sm">Quay lại danh sách</a>
            </div>
        </form>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set maximum date (3 years from now)
            const maxDate = new Date();
            maxDate.setFullYear(maxDate.getFullYear() + 3);
            const formattedMax = maxDate.toISOString().slice(0, 16);

            // Get the date input fields
            const startTimeInput = document.getElementById('startTimeInput');
            const endTimeInput = document.getElementById('endTimeInput');

            // Set max attribute and ensure inputs are properly initialized
            if (startTimeInput) {
                startTimeInput.max = formattedMax;
                // Set minimum to current time if no value is set
                if (!startTimeInput.value) {
                    const now = new Date();
                    startTimeInput.min = now.toISOString().slice(0, 16);
                }
            }

            if (endTimeInput) {
                endTimeInput.max = formattedMax;
                // Set minimum to current time if no value is set
                if (!endTimeInput.value) {
                    const now = new Date();
                    endTimeInput.min = now.toISOString().slice(0, 16);
                }
            }

            // Form validation
            const promotionForm = document.getElementById('createPromotionForm');
            if (promotionForm) {
                promotionForm.addEventListener('submit', function(e) {
                    // Check start time
                    if (!startTimeInput || !startTimeInput.value) {
                        alert('Thời gian bắt đầu không được để trống');
                        e.preventDefault();
                        return false;
                    }

                    // Check end time
                    if (!endTimeInput || !endTimeInput.value) {
                        alert('Thời gian kết thúc không được để trống');
                        e.preventDefault();
                        return false;
                    }

                    // Check that end time is after start time
                    const startDate = new Date(startTimeInput.value);
                    const endDate = new Date(endTimeInput.value);

                    if (endDate <= startDate) {
                        alert('Thời gian kết thúc phải sau thời gian bắt đầu');
                        e.preventDefault();
                        return false;
                    }

                    return true;
                });
            }

            // Show/hide discount fields based on selected radio
            const discountLevelRadio = document.getElementById('discountLevelRadio');
            const discountAmountRadio = document.getElementById('discountAmountRadio');
            const discountLevelField = document.getElementById('discountLevelField');
            const discountAmountField = document.getElementById('discountAmountField');

            // Function to update discount field visibility
            function updateDiscountFields() {
                if (discountLevelRadio.checked) {
                    discountLevelField.style.display = 'block';
                    discountAmountField.style.display = 'none';
                    // Ensure discountAmount is cleared when percentage is selected
                    const discountAmountInput = document.getElementById('discountAmountInput');
                    if (discountAmountInput) discountAmountInput.value = '';
                } else if (discountAmountRadio.checked) {
                    discountAmountField.style.display = 'block';
                    discountLevelField.style.display = 'none';
                    // Ensure discountLevel is cleared when fixed amount is selected
                    const discountLevelInput = document.getElementById('discountLevelInput');
                    if (discountLevelInput) discountLevelInput.value = '';
                }
            }

            // Set initial state
            updateDiscountFields();

            // Add listeners
            if (discountLevelRadio) {
                discountLevelRadio.addEventListener('change', updateDiscountFields);
            }
            if (discountAmountRadio) {
                discountAmountRadio.addEventListener('change', updateDiscountFields);
            }
        });

        // Image preview functions
        function handleImageInputChange() {
            const imageUrl = document.getElementById('imageUrlInput').value;
            const preview = document.getElementById('imagePreview');
            if (imageUrl) {
                preview.src = imageUrl;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        function handleImageFileChange() {
            const fileInput = document.getElementById('imageFileInput');
            const preview = document.getElementById('imagePreview');

            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(fileInput.files[0]);
                // Clear the URL input to avoid confusion
                document.getElementById('imageUrlInput').value = '';
            }
        }
    </script>
</main>
</body>
</html>