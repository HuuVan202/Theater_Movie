<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quản Lý Lịch Chiếu Phim - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" th:href="@{/css/viewMember.css}" href="/css/viewMember.css">
    <link rel="stylesheet" th:href="@{/css/admin/movie_showtimes.css}" href="/css/admin/movie_showtimes.css">
    <link rel="apple-touch-icon" sizes="180x180" th:href="@{/favicon/apple-touch-icon.png}">
    <link rel="icon" type="image/png" sizes="32x32" th:href="@{/favicon/favicon-32x32.png}">
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/favicon/favicon-16x16.png}">
    <link rel="manifest" th:href="@{/favicon/site.webmanifest}">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon/favicon.ico}">
</head>

<body>
<div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar" class="bg-white border-end sidebar-custom">
        <div class="sidebar-header p-3 border-bottom">
            <h5 class="mb-0 fw-bold text-danger"><i class="bi bi-film me-2"></i>Cinema Admin</h5>
        </div>
        <ul class="list-unstyled components p-3 mb-0">
            <li class="mb-2"><a th:href="@{/}" class="nav-link sidebar-link"><i
                    class="bi bi-house-door me-2"></i>Trang chủ</a></li>
            <li class="mb-2"><a th:href="@{/admin/employees}" class="nav-link sidebar-link"><i
                    class="bi bi-person-badge me-2"></i>Nhân Viên</a></li>
            <li class="mb-2"><a th:href="@{/admin/members}" class="nav-link sidebar-link"><i
                    class="bi bi-people me-2"></i>Khách hàng</a></li>
            <li class="mb-2"><a href="#" class="nav-link sidebar-link active"><i class="bi bi-calendar2-week me-2"></i>Lịch
                chiếu</a></li>
            <li class="mb-2"><a href="#" class="nav-link sidebar-link"><i
                    class="bi bi-ticket-perforated me-2"></i>Đặt vé</a></li>
            <li class="mb-2"><a href="#" class="nav-link sidebar-link"><i class="bi bi-camera-reels me-2"></i>Doanh
                thu</a></li>
            <li class="mb-2"><a href="#" class="nav-link sidebar-link"><i
                    class="bi bi-bar-chart-line me-2"></i>Thống kê</a></li>
            <li class="mb-2"><a th:href="@{/admin/promotions/list}" class="nav-link sidebar-link"><i
                    class="bi bi-gift me-2"></i>Khuyến mãi</a></li>
        </ul>
        <div class="sidebar-footer p-3 border-top mt-auto">
            <div class="mb-2 small"><i class="bi bi-person-circle me-2"></i>Admin</div>
            <div class="mb-2 small"><i class="bi bi-gear me-2"></i>Cài đặt</div>
            <div class="small"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</div>
        </div>
    </nav>

    <!-- Page Content -->
    <div id="page-content-wrapper" class="flex-grow-1">
        <!-- Top Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light bg-danger shadow-sm px-3">
            <div class="container-fluid px-0">
                <span class="navbar-brand text-white fw-bold"><i class="bi bi-calendar2-week me-2"></i>Quản lý lịch chiếu phim</span>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container py-4">
            <div class="movie-container">
                <!-- Date Selector (AC-01) -->
                <div class="date-selector-container">
            <label for="dateSelector" class="date-selector-label">Chọn Ngày Chiếu:</label>
            <input type="date" id="dateSelector" class="date-selector">
        </div>

        <!-- Filter Options -->
        <div class="filter-row">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <span class="filter-label">Lọc Theo:</span>
                </div>
                <div class="col-md-10">
                    <div class="filter-options">
                        <span class="filter-option active" data-filter="all">Tất cả</span>
                        <span class="filter-option" data-filter="action">Hành động</span>
                        <span class="filter-option" data-filter="comedy">Hài</span>
                        <span class="filter-option" data-filter="drama">Tâm lý</span>
                        <span class="filter-option" data-filter="horror">Kinh dị</span>
                        <span class="filter-option" data-filter="animation">Hoạt hình</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- No Showtimes Message (AC-04) -->
        <div id="noShowtimesMessage" class="no-showtimes d-none">
            <i class="fas fa-calendar-times"></i>
            <h3>Không Có Suất Chiếu</h3>
            <p>Không có suất chiếu nào vào ngày đã chọn. Vui lòng chọn một ngày khác.</p>
        </div>

        <!-- Movies Container (AC-02) -->
        <div id="moviesContainer" class="row"></div>
            </div>
        </div>
    </div>
</div>

<!-- Movie Card Template -->
<template id="movieCardTemplate">
    <div class="col-lg-4 col-md-6 movie-card-container">
        <div class="movie-card">
            <img class="movie-poster" src="" alt="Movie Poster">
            <div class="movie-info">
                <h3 class="movie-title"></h3>
                <div class="movie-meta">
                    <span class="movie-duration"><i class="far fa-clock me-1"></i> <span class="duration-text"></span> phút</span>
                    <div>
                        <span class="badge badge-genre"></span>
                        <span class="badge badge-rating"></span>
                    </div>
                </div>
                <hr>
                <div class="showtimes">
                    <!-- Showtimes will be added here -->
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const dateSelector = document.getElementById('dateSelector');
            const moviesContainer = document.getElementById('moviesContainer');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const noShowtimesMessage = document.getElementById('noShowtimesMessage');
            const movieCardTemplate = document.getElementById('movieCardTemplate');
            const filterOptions = document.querySelectorAll('.filter-option');

            // Initialize Flatpickr for date selection (AC-01)
            flatpickr(dateSelector, {
                dateFormat: "Y-m-d",
                minDate: "today",
                maxDate: new Date().fp_incr(14), // Allow booking up to 14 days in advance
                defaultDate: "today",
                onChange: function(selectedDates, dateStr) {
                    // Load showtimes when a date is selected (AC-02)
                    loadShowtimes(dateStr);
                }
            });

            // Filter functionality
            filterOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Update active class
                    filterOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');

                    const filter = this.dataset.filter;
                    applyFilter(filter);
                });
            });

            // Function to apply genre filter
            function applyFilter(filter) {
                const movieCards = document.querySelectorAll('.movie-card-container');

                movieCards.forEach(card => {
                    const genre = card.dataset.genre;

                    if (filter === 'all' || genre.includes(filter)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }

            // Function to load showtimes for selected date (AC-02)
            function loadShowtimes(date) {
                // Show loading spinner
                moviesContainer.innerHTML = '';
                loadingSpinner.classList.remove('d-none');
                noShowtimesMessage.classList.add('d-none');

                // In a real application, this would be an API call
                // For this demo, we'll simulate with mock data and a delay
                setTimeout(() => {
                    // Hide loading spinner
                    loadingSpinner.classList.add('d-none');

                    // Get movies data (AC-05)
                    const movies = getMoviesForDate(date);

                    if (movies.length === 0) {
                        // Show no showtimes message (AC-04)
                        noShowtimesMessage.classList.remove('d-none');
                    } else {
                        // Render movies with showtimes (AC-02)
                        renderMovies(movies);
                    }
                }, 800); // Simulate network delay
            }

            // Function to render movies and their showtimes (AC-02)
            function renderMovies(movies) {
                moviesContainer.innerHTML = '';

                movies.forEach(movie => {
                    // Clone template
                    const movieCard = movieCardTemplate.content.cloneNode(true);
                    const movieCardContainer = movieCard.querySelector('.movie-card-container');

                    // Set movie data
                    const posterImg = movieCard.querySelector('.movie-poster');
                    posterImg.src = movie.posterUrl;
                    posterImg.alt = `${movie.title} Poster`;

                    movieCard.querySelector('.movie-title').textContent = movie.title;
                    movieCard.querySelector('.duration-text').textContent = movie.duration;
                    movieCard.querySelector('.badge-genre').textContent = movie.genre;
                    movieCard.querySelector('.badge-rating').textContent = movie.rating;

                    // Set dataset for filtering
                    movieCardContainer.dataset.genre = movie.genre.toLowerCase();

                    // Add showtimes
                    const showtimesContainer = movieCard.querySelector('.showtimes');
                    movie.showtimes.forEach(showtime => {
                        const button = document.createElement('button');
                        button.classList.add('showtime-btn');
                        button.textContent = showtime.time;

                        // Add click event for showtime (AC-03)
                        button.addEventListener('click', () => {
                            // In a real app, this would be a form submit or API call
                            // For this demo, we'll just simulate with an alert and console log
                            console.log(`Selected: Movie ID ${movie.id}, Date ${dateSelector.value}, Showtime ID ${showtime.id}`);
                            redirectToSeatSelection(movie.id, dateSelector.value, showtime.id);
                        });

                        showtimesContainer.appendChild(button);
                    });

                    moviesContainer.appendChild(movieCard);
                });
            }

            // Function to redirect to seat selection (AC-03)
            function redirectToSeatSelection(movieId, date, showtimeId) {
                // In a real application, this would redirect to an actual page
                // For this demo, we'll just show a confirmation alert
                alert(`Đang chuyển đến trang đặt ghế cho:\nPhim ID: ${movieId}\nNgày: ${date}\nSuất chiếu ID: ${showtimeId}`);

                // Simulate redirect
                window.location.href = `seat-selection.html?movieId=${movieId}&date=${date}&showtimeId=${showtimeId}`;
            }

            // Mock data function to simulate API response (AC-05)
            function getMoviesForDate(date) {
                // In a real application, this data would come from an API
                // The data would reflect active movies and valid showtimes (AC-05)

                // For demo purposes, let's show movies for today and tomorrow, and no movies for other dates
                const today = new Date().toISOString().split('T')[0];
                const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];

                if (date === today || date === tomorrow) {
                    return [
                        {
                            id: 1,
                            title: "Dune: Hành Tinh Cát - Phần Hai",
                            duration: 166,
                            genre: "Khoa Học Viễn Tưởng",
                            rating: "PG-13",
                            posterUrl: "https://m.media-amazon.com/images/M/MV5BN2QyY2I5OTMtMjA5OC00MDZiLWI1NzQtZmU1MTjlkMGM1YzhmXkEyXkFqcGdeQXVyNzAwMjU2MTY@._V1_.jpg",
                            showtimes: [
                                { id: 101, time: "10:15" },
                                { id: 102, time: "13:30" },
                                { id: 103, time: "17:45" },
                                { id: 104, time: "21:00" }
                            ]
                        },
                        {
                            id: 2,
                            title: "Inside Out 2",
                            duration: 96,
                            genre: "Hoạt Hình",
                            rating: "G",
                            posterUrl: "https://m.media-amazon.com/images/M/MV5BNWM1NzFhMzgtYzljYS00ZmY5LTljYmUtNTQyNGI5MmYxOTkwXkEyXkFqcGdeQXVyMTI5NjI2NjE1._V1_.jpg",
                            showtimes: [
                                { id: 201, time: "09:30" },
                                { id: 202, time: "12:00" },
                                { id: 203, time: "14:30" },
                                { id: 204, time: "17:00" }
                            ]
                        },
                        {
                            id: 3,
                            title: "Deadpool & Wolverine",
                            duration: 124,
                            genre: "Hành Động",
                            rating: "R",
                            posterUrl: "https://m.media-amazon.com/images/M/MV5BMDkyMmZlN2EtMTAwYi00OWQ2LTlkODAtMDllOThjMDllZTZlOCXkEyXkFqcGdeQXVyNDQ5MjMwMjY@._V1_.jpg",
                            showtimes: [
                                { id: 301, time: "11:45" },
                                { id: 302, time: "15:15" },
                                { id: 303, time: "18:45" },
                                { id: 304, time: "22:00" }
                            ]
                        },
                        {
                            id: 4,
                            title: "Venom: The Last Dance",
                            duration: 112,
                            genre: "Hành Động",
                            rating: "PG-13",
                            posterUrl: "https://m.media-amazon.com/images/M/MV5BM2Y2NTk2MjUtNGVhYS00YTJlLWI0MGQtNTMwYTY1MTVhMDkyXkEyXkFqcGdeQXVyODk4OTc3MTY@._V1_.jpg",
                            showtimes: [
                                { id: 401, time: "12:30" },
                                { id: 402, time: "16:00" },
                                { id: 403, time: "19:30" },
                                { id: 404, time: "22:30" }
                            ]
                        },
                        {
                            id: 5,
                            title: "Twisters",
                            duration: 118,
                            genre: "Hành Động",
                            rating: "PG-13",
                            posterUrl: "https://m.media-amazon.com/images/M/MV5BMGFhZDdjZGItNzY4ZS00OGM2LWJkZmMtYWZlYWJlYzZhMzkwXkEyXkFqcGdeQXVyMTUzMTg2ODkz._V1_.jpg",
                            showtimes: [
                                { id: 501, time: "10:45" },
                                { id: 502, time: "14:15" },
                                { id: 503, time: "17:30" },
                                { id: 504, time: "20:45" }
                            ]
                        },
                        {
                            id: 6,
                            title: "The Fall Guy",
                            duration: 126,
                            genre: "Hài",
                            rating: "PG-13",
                            posterUrl: "https://m.media-amazon.com/images/M/MV5BM2NkZjEzZGMtZDhiMi00MzgzLTljYTctOWY4ZTZkZjU4YTFjXkEyXkFqcGdeQXVyNzAwMjU2MTY@._V1_.jpg",
                            showtimes: [
                                { id: 601, time: "11:00" },
                                { id: 602, time: "15:45" },
                                { id: 603, time: "19:00" }
                            ]
                        }
                    ];
                } else {
                    // Return empty array for dates without showtimes
                    return [];
                }
            }

            // Load today's showtimes on page load
            const today = new Date().toISOString().split('T')[0];
            dateSelector.value = today;
            loadShowtimes(today);
        });
    </script>
</body>
</html>
