<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layoutAdmin}">

<head>
  <meta charset="UTF-8">
  <title layout:title-pattern="Cinema Admin">Th·ªëng K√™</title>
  <link rel="stylesheet" th:href="@{/css/admin-statistic.css}">
  <style>
    form {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px; /* kho·∫£ng c√°ch gi·ªØa c√°c nh√≥m */
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    label {
      font-weight: bold;
      margin-right: 8px;
    }

    select, input[type="date"], input[type="number"], button {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 4px rgba(76, 175, 80, 0.4);
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    /* ·∫®n c√°c filter kh√¥ng d√πng */
    .filter {
      display: flex;
      align-items: center;
      gap: 5px;
    }
  </style>

</head>

<body>
<div layout:fragment="header">
  <div th:replace="~{fragments/title_admin :: header('Th·ªëng k√™ doanh thu & v√©', 'bi-film')}"></div>
</div>
<div layout:fragment="content">
  <div class="container">
    <form method="get" action="/admin/stats/export" class="export-form">
      <label>Ch·∫ø ƒë·ªô l·ªçc:
        <select id="filterType" name="filterType">
          <option value="day">Theo ng√†y</option>
          <option value="week">Tu·∫ßn n√†y</option>
          <option value="month">Th√°ng n√†y</option>
          <option value="year">NƒÉm</option>
          <option value="range">Kho·∫£ng th·ªùi gian</option>
        </select>
      </label>

      <div id="dayInput" class="filter">
        <label>Ng√†y:</label>
        <input type="date" name="day">
      </div>

      <div id="monthInput" class="filter" style="display: none;">
        <!-- Kh√¥ng c·∫ßn input v√¨ l·∫•y th√°ng hi·ªán t·∫°i trong controller -->
      </div>

      <div id="yearInput" class="filter" style="display: none;">
        <label>NƒÉm:</label>
        <input type="number" name="yearInput" id="yearValue" min="2020" max="2099">
      </div>

      <div id="rangeInput" class="filter" style="display: none;">
        <label>T·ª´ ng√†y:</label>
        <input type="date" name="fromDate">
        <label>ƒê·∫øn ng√†y:</label>
        <input type="date" name="toDate">
      </div>

      <button type="submit">Xu·∫•t B√°o C√°o</button>
    </form>

    <!-- Revenue Chart Section -->
    <h2>Doanh thu</h2>
    <form method="get" action="/admin/stats/all" class="filter-form revenue-filter">
      <label for="revenueMode">Ch·∫ø ƒë·ªô th·ªëng k√™:</label>
      <select name="revenueMode" id="revenueMode">
        <option value="day" th:selected="${revenueMode == 'day'}">Ng√†y trong th√°ng</option>
        <option value="month" th:selected="${revenueMode == 'month'}">12 th√°ng trong nƒÉm</option>
        <option value="quarter" th:selected="${revenueMode == 'quarter'}">Theo qu√Ω</option>
        <option value="compareYear" th:selected="${revenueMode == 'compareYear'}">So s√°nh nhi·ªÅu nƒÉm</option>
      </select>

      <!-- B·ªô l·ªçc nƒÉm -->
      <label for="revenueYear" class="year-filter hidden">NƒÉm:</label>
      <select name="revenueYear" id="revenueYear" class="year-filter hidden">
        <option value="2023" th:selected="${selectedRevenueYear == '2023'}">2023</option>
        <option value="2024" th:selected="${selectedRevenueYear == '2024'}">2024</option>
        <option value="2025" th:selected="${selectedRevenueYear == '2025'}">2025</option>
      </select>

      <!-- B·ªô l·ªçc th√°ng -->
      <!-- CSS t·ªëi ∆∞u -->
      <label for="selectedMonth" class="month-filter hidden">Th√°ng:</label>
      <select name="selectedMonth" id="selectedMonth" class="month-filter hidden">
        <option th:each="month : ${#numbers.sequence(1,12)}"
                th:value="${month}"
                th:text="'Th√°ng ' + ${month}"
                th:selected="${selectedMonth != null && selectedMonth == month.toString()}">
        </option>
      </select>

      <button type="submit">C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì</button>
    </form>

    <!-- Canvas lu√¥n c√≥ s·∫µn trong DOM -->
    <canvas id="revenueChart"
            width="1000" height="400"
            style="background: #fff; border-radius: 10px; margin-bottom: 40px;">
    </canvas>

    <!-- Th√¥ng b√°o kh√¥ng c√≥ d·ªØ li·ªáu lu√¥n c√≥ s·∫µn nh∆∞ng ·∫©n ƒëi ban ƒë·∫ßu -->
    <div id="noDataMessage"
         style="display: none; text-align: center; padding: 1rem; background: #fff9e6; color: #555; border-radius: 8px; font-weight: bold;">
      Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.
    </div>


    <!-- Trang doanh thu h√¥m nay -->
    <div class="card-dashboard">
      <div class="dashboard-card">
        <!-- Doanh thu h√¥m nay -->
        <h2>Doanh thu h√¥m nay</h2>
        <table>
          <thead>
          <tr>
            <th style="font-weight: bold">T√™n phim</th>
            <th style="font-weight: bold">Doanh thu</th>
            <th style="font-weight: bold">S·ªë v√© b√°n</th>
            <th style="font-weight: bold">S·ªë su·∫•t chi·∫øu</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="dto : ${dailyRevenueStats}">
            <td th:text="${dto.movieName}">T√™n phim</td>
            <td th:text="${#numbers.formatDecimal(dto.totalRevenue, 0, 'COMMA', 0, 'POINT')} + ' ƒë'">0 ƒë
            </td>
            <td th:text="${dto.totalTickets}">0</td>
            <td th:text="${dto.totalShowtimes}">0</td>
          </tr>
          </tbody>
        </table>
      </div>
      <!-- re-Booked Ticket Statistics -->
      <div class="dashboard-card">
        <h2>Th·ªëng k√™ v√© ƒë√£ ƒë·∫∑t tr∆∞·ªõc</h2>
        <div class="table-scroll">
          <table>
            <thead>
            <tr>
              <th style="text-align: left">T√™n Phim</th>
              <th style="text-align: center">V√© ƒë√£ ƒë·∫∑t tr∆∞·ªõc</th>
              <th style="text-align: right">Doanh thu</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="preBookedStat : ${preBookedStats}">
              <td th:text="${preBookedStat.movieName}"></td>
              <td th:text="${preBookedStat.preBookedTickets}"></td>
              <td th:text="${#numbers.formatDecimal(preBookedStat.getTotalRevenue, 0, 'COMMA', 0, 'POINT')} + ' ƒë'">0 ƒë</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
    <div class="chart-section">
      <div id="genreChartContainer" style="max-width: 2000px; ">
        <h2>Doanh thu th·ªÉ lo·∫°i</h2>
        <div style="position: relative; height: 400px;">
          <canvas id="genreRevenueChart" style="background: #fff; border-radius: 10px;"></canvas>
        </div>
      </div>
      <div id="peakHourContainer" style="max-width: 2000px; margin: 0 auto;">
        <h2>Doanh Thu Theo Khung Gi·ªù</h2>
        <div style="position: relative; height: 400px;">
          <canvas id="peakHourHeatMap" style="background: #fff; border-radius: 10px;"></canvas>
        </div>
      </div>
    </div>

    <!-- chart bieu do tron -->
    <div class="dashboard-row">
      <!-- Top 10 Customers -->
      <div class="dashboard-card">
        <h2>10 Kh√°ch h√†ng h√†ng ƒë·∫ßu</h2>
        <table>
          <thead>
          <tr>
            <th>#</th>
            <th>T√™n ƒëƒÉng nh·∫≠p</th>
            <th>S·ªë l∆∞·ª£ng v√©</th>
            <th>T·ªïng s·ªë ti·ªÅn ƒë√£ chi</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="top, iter : ${topCustomerStatsList}">
            <td th:text="${iter.count}"></td>
            <td th:text="${top.username}"></td>
            <td th:text="${top.ticketCount}"></td>
            <td th:text="${#numbers.formatDecimal(top.totalSpent, 0, 'COMMA', 0, 'POINT')} + ' ƒë'">0 ƒë
          </tr>
          </tbody>
        </table>
      </div>
      <!-- Ph√¢n lo·∫°i kh√°ch h√†ng -->
      <div class="customer-tier">
        <h3>Ph√¢n lo·∫°i kh√°ch h√†ng</h3>
        <p><strong>T·ªïng t√†i kho·∫£n:</strong>
          <span th:text="${totalAccounts}">0</span>
        </p>
        <canvas id="accountTierChart" width="400" height="400"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.0.0/dist/chartjs-chart-matrix.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!--  xu·∫•t excel-->
  <script>
    document.querySelector(".export-form").addEventListener("submit", function (e) {
      const formLogout = document.getElementById('adminLogoutForm');
      const checkLogout = document.querySelector("form");

      // Only execute if formLogout and checkLogout are different
      if (formLogout !== checkLogout) {
        const filterType = document.getElementById("filterType").value;

        if (filterType === "day") {
          const dayInput = document.querySelector("input[name='day']").value;
          if (!dayInput) {
            e.preventDefault();
            alert("Vui l√≤ng ch·ªçn ng√†y tr∆∞·ªõc khi xu·∫•t Excel.");
          }
        }

        if (filterType === "range") {
          const fromDate = document.querySelector("input[name='fromDate']").value;
          const toDate = document.querySelector("input[name='toDate']").value;
          if (!fromDate || !toDate) {
            e.preventDefault();
            alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß kho·∫£ng th·ªùi gian.");
          }
        }

        if (filterType === "year") {
          const yearInput = document.querySelector("input[name='yearInput']").value;
          if (!yearInput) {
            e.preventDefault();
            alert("Vui l√≤ng nh·∫≠p nƒÉm.");
          }
        }
      }
    });
  </script>
<!--  th·ªëng k√™ th√†nh vi√™n-->
  <script th:inline="javascript">
    let tierStats = /*[[${tierStats}]]*/[];

    // ƒê·ªãnh nghƒ©a m√†u s·∫Øc cho t·ª´ng tier c·ª• th·ªÉ
    const tierColors = {
      'b·∫°c': '#C0C0C0',     // M√†u b·∫°c th·ª±c t·∫ø
      'silver': '#C0C0C0',  // H·ªó tr·ª£ ti·∫øng Anh
      'v√†ng': '#FFD700',    // M√†u v√†ng th·ª±c t·∫ø
      'gold': '#FFD700',    // H·ªó tr·ª£ ti·∫øng Anh
      'kim c∆∞∆°ng': '#B9F2FF', // M√†u kim c∆∞∆°ng s√°ng
      'diamond': '#B9F2FF', // H·ªó tr·ª£ ti·∫øng Anh
      'Kh√¥ng x√°c ƒë·ªãnh': '#94A3B8' // M√†u x√°m nh·∫π
    };

    let tierLabels = tierStats.map(r => r.tier || 'Kh√¥ng x√°c ƒë·ªãnh');
    let tierData = tierStats.map(r => r.total);

    // T·∫°o m·∫£ng m√†u s·∫Øc d·ª±a tr√™n tier th·ª±c t·∫ø
    let tierBackgroundColors = tierLabels.map(tier => {
      // Chuy·ªÉn v·ªÅ ch·ªØ th∆∞·ªùng ƒë·ªÉ so s√°nh
      const lowerTier = tier.toLowerCase();
      return tierColors[lowerTier] || tierColors['Kh√¥ng x√°c ƒë·ªãnh'];
    });

    new Chart(document.getElementById('accountTierChart'), {
      type: 'pie',
      data: {
        labels: tierLabels,
        datasets: [{
          label: 'Ph√¢n lo·∫°i theo h·∫°ng',
          data: tierData,
          backgroundColor: tierBackgroundColors
        }]
      },
      options: {
        plugins: {
          title: {
            display: true,
            text: 'Ph√¢n lo·∫°i kh√°ch h√†ng theo h·∫°ng'
          }
        }
      }
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const yearSelect = document.getElementById('year');
      const monthSelect = document.getElementById('month');
      const quarterSelect = document.getElementById('quarter');

      // Khi ch·ªçn month, t·ª± ƒë·ªông clear quarter v√† ng∆∞·ª£c l·∫°i
      monthSelect.addEventListener('change', function () {
        if (this.value) {
          quarterSelect.value = '';
        }
      });

      quarterSelect.addEventListener('change', function () {
        if (this.value) {
          monthSelect.value = '';
        }
      });

      // Disable month/quarter n·∫øu kh√¥ng ch·ªçn year (t√πy ch·ªçn)
      function toggleMonthQuarter() {
        const hasYear = yearSelect.value !== '';
        // Uncomment below lines if you want to disable month/quarter when no year is selected
        // monthSelect.disabled = !hasYear;
        // quarterSelect.disabled = !hasYear;
      }

      yearSelect.addEventListener('change', toggleMonthQuarter);
      toggleMonthQuarter(); // Initial call
    });
  </script>
<!--  bi·ªÉu ƒë·ªì-->
  <script th:inline="javascript">
    // S·ª≠ d·ª•ng c√∫ ph√°p Thymeleaf ƒë√∫ng c√°ch
    /*<![CDATA[*/
    var revenueData = /*[[${revenueStats}]]*/[];
    var mode = /*[[${revenueMode}]]*/ 'month';
    var selectedYear = /*[[${selectedRevenueYear}]]*/ '2025';
    var selectedMonth = /*[[${selectedMonth}]]*/ ''; // Th√™m bi·∫øn n√†y
    /*]]>*/

    console.log('Revenue Data:', revenueData);
    console.log('Mode:', mode);
    console.log('Selected Year:', selectedYear);
    console.log('Selected Month:', selectedMonth);
    console.log('Data length:', revenueData.length);

    function createChart() {
      const ctx = document.getElementById('revenueChart');
      if (!ctx) {
        console.error('Canvas element with id "revenueChart" not found');
        return;
      }

      if (window.revenueChart instanceof Chart) {
        window.revenueChart.destroy();
      }

      try {
        let labels = [];
        let values = [];
        let chartTitle = '';
        let chartType = 'line';

        // T·∫°o m·ªôt map ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu t·ª´ backend m·ªôt c√°ch an to√†n v√† d·ªÖ d√†ng
        const dataMap = new Map();
        revenueData.forEach(stat => {
          if (stat) {
            let key = '';
            if (stat.year) key = stat.year.toString();
            else if (stat.quarter) key = stat.quarter.split(' - ')[0]; // Ch·ªâ l·∫•y Q1, Q2...
            else if (stat.month) key = stat.month.toString();

            const revenueValue = Number(stat.totalRevenue) || 0;
            if (key) {
              dataMap.set(key, revenueValue);
            }
          }
        });

        console.log("Processed Data Map:", dataMap);

        switch (mode) {
          case 'compareYear':
            chartType = 'bar';
            chartTitle = 'So s√°nh doanh thu c√°c nƒÉm';
            const currentYear = new Date().getFullYear();
            const startYear = 2023;
            for (let year = startYear; year <= currentYear; year++) {
              const yearStr = year.toString();
              labels.push(yearStr);
              values.push(dataMap.get(yearStr) || 0);
            }
            break;

          case 'quarter':
            labels = ['Q1', 'Q2', 'Q3', 'Q4'];
            values = revenueData.map(stat => stat.totalRevenue || 0);
            chartTitle = 'Doanh thu theo qu√Ω (' + selectedYear + ')';
            break;

          case 'day':
            // Gi·ªØ nguy√™n logic c≈© c·ªßa b·∫°n
            labels = revenueData.map(stat => stat.month || '');
            values = revenueData.map(stat => stat.totalRevenue || 0);
            const monthElement = document.getElementById('selectedMonth');
            const currentMonth = monthElement ? monthElement.value : selectedMonth;
            chartTitle = 'Doanh thu theo ng√†y (' + selectedYear + '-' + (currentMonth || '') + ')';
            break;

          case 'month':
            chartType = 'line';
            chartTitle = `Doanh thu theo th√°ng (${selectedYear})`;
            for (let i = 1; i <= 12; i++) {
              const monthKey = i.toString().padStart(2, '0');
              labels.push(monthKey);
              values.push(dataMap.get(monthKey) || 0);
            }
            break;
        }

        console.log("Processed Labels:", labels);
        console.log("Processed Values:", values);

        // --- X·ª≠ l√Ω hi·ªÉn th·ªã bi·ªÉu ƒë·ªì ---
        const hasActualData = values.some(val => val > 0);
        const canvas = document.getElementById('revenueChart');
        const noDataMessage = document.getElementById('noDataMessage');

        if (!hasActualData) {
          if (canvas) canvas.style.display = 'none';
          if (noDataMessage) {
            noDataMessage.style.display = 'block';
            noDataMessage.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu doanh thu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.';
          }
          return;
        }

        if (canvas) canvas.style.display = 'block';
        if (noDataMessage) noDataMessage.style.display = 'none';

        window.revenueChart = new Chart(ctx.getContext('2d'), {
          type: chartType,
          data: {
            labels: labels,
            datasets: [{
              label: 'Doanh thu',
              data: values,
              borderColor: '#2ecc71',
              backgroundColor: 'rgba(46, 204, 113, 0.2)',
              fill: true,
              tension: 0.2,
              pointRadius: 5,
              pointBackgroundColor: '#27ae60'
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: { display: true, text: chartTitle }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Doanh thu (VNƒê)' }
              },
              x: {
                title: { display: true, text: 'Th·ªùi gian' }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error creating revenue chart:', error);
      }
    }

    function updateRevenueFilterFields() {
      const revenueModeEl = document.getElementById('revenueMode');
      if (!revenueModeEl) {
        console.warn('revenueMode element not found');
        return;
      }

      const currentMode = revenueModeEl.value;
      const yearSelect = document.getElementById('revenueYear');
      const monthSelect = document.getElementById('selectedMonth');
      const yearLabel = document.querySelector("label[for='revenueYear']");
      const monthLabel = document.querySelector("label[for='selectedMonth']");

      if (!yearSelect || !monthSelect) {
        console.warn('Year or month select elements not found');
        return;
      }

      yearSelect.removeAttribute('name');
      monthSelect.removeAttribute('name');
      [yearSelect, monthSelect, yearLabel, monthLabel].forEach(el => el && (el.style.display = 'none'));

      if (currentMode === 'day') {
        yearSelect.style.display = 'inline-block';
        if (yearLabel) yearLabel.style.display = 'inline-block';
        monthSelect.style.display = 'inline-block';
        if (monthLabel) monthLabel.style.display = 'inline-block';
        yearSelect.setAttribute('name', 'revenueYear');
        monthSelect.setAttribute('name', 'selectedMonth');
        updateDayModeLabel();
      } else if (currentMode === 'month' || currentMode === 'quarter') {
        yearSelect.style.display = 'inline-block';
        if (yearLabel) yearLabel.style.display = 'inline-block';
        yearSelect.setAttribute('name', 'revenueYear');
      }
    }

    function updateDayModeLabel() {
      const yearEl = document.getElementById('revenueYear');
      const monthEl = document.getElementById('selectedMonth');
      if (!yearEl || !monthEl) {
        console.warn('Year or month elements not found for day mode label update');
        return;
      }

      const year = parseInt(yearEl.value);
      const month = parseInt(monthEl.value);
      const daysInMonth = new Date(year, month, 0).getDate();
      const dayOption = document.querySelector('#revenueMode option[value="day"]');
      if (dayOption) dayOption.textContent = `${daysInMonth} ng√†y trong th√°ng`;
    }

    function restoreFiltersFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const urlMode = urlParams.get('revenueMode');
      const year = urlParams.get('revenueYear');
      const month = urlParams.get('selectedMonth');
      const revenueModeEl = document.getElementById('revenueMode');
      const revenueYearEl = document.getElementById('revenueYear');
      const selectedMonthEl = document.getElementById('selectedMonth');

      if (urlMode && revenueModeEl) revenueModeEl.value = urlMode;
      if (year && revenueYearEl) revenueYearEl.value = year;
      if (month && selectedMonthEl) selectedMonthEl.value = month;
    }

    document.addEventListener('DOMContentLoaded', function () {
      console.log('DOM loaded, initializing...');
      restoreFiltersFromURL();
      updateRevenueFilterFields();
      createChart();

      const revenueModeEl = document.getElementById('revenueMode');
      const revenueYearEl = document.getElementById('revenueYear');
      const selectedMonthEl = document.getElementById('selectedMonth');

      if (revenueModeEl) {
        revenueModeEl.addEventListener('change', function () {
          updateRevenueFilterFields();
          const yearSelect = document.getElementById('revenueYear');
          const yearLabel = document.querySelector('label[for="revenueYear"]');
          if (yearSelect && yearLabel) {
            if (this.value === 'month') {
              yearSelect.style.display = 'inline-block';
              yearLabel.style.display = 'inline';
            } else if (this.value === 'year') {
              yearSelect.style.display = 'none';
              yearLabel.style.display = 'none';
            }
          }
        });
      }

      if (revenueYearEl) {
        revenueYearEl.addEventListener('change', function () {
          if (revenueModeEl && revenueModeEl.value === 'day') {
            updateDayModeLabel();
            // C·∫≠p nh·∫≠t l·∫°i bi·ªÉu ƒë·ªì khi thay ƒë·ªïi nƒÉm
            createChart();
          }
        });
      }

      if (selectedMonthEl) {
        selectedMonthEl.addEventListener('change', function () {
          if (revenueModeEl && revenueModeEl.value === 'day') {
            updateDayModeLabel();
            // C·∫≠p nh·∫≠t l·∫°i bi·ªÉu ƒë·ªì khi thay ƒë·ªïi th√°ng
            createChart();
          }
        });
      }
    });
  </script>
<!--  th·ªëng k√™ theo gi·ªù-->
  <script th:inline="javascript">
    /*<![CDATA[*/
    var peakHourData = /*[[${peakHourRevenues}]]*/[];
    /*]]>*/

    console.log('Peak Hour Data:', peakHourData);

    // Bi·∫øn global ƒë·ªÉ theo d√µi tr·∫°ng th√°i chart
    let peakHourChartCreated = false;

    function createPeakHourHeatMap() {
      const container = document.getElementById('peakHourContainer');

      // X√≥a canvas c≈© n·∫øu c√≥
      const oldCanvas = document.getElementById('peakHourHeatMap');
      if (oldCanvas) oldCanvas.remove();

      // T·∫°o l·∫°i canvas v√† g·∫Øn v√†o container
      const newCanvas = document.createElement('canvas');
      newCanvas.id = 'peakHourHeatMap';
      newCanvas.style.background = '#fff';
      newCanvas.style.borderRadius = '10px';
      newCanvas.style.width = '100%';
      newCanvas.style.height = '100%';

      const chartWrapper = document.createElement('div');
      chartWrapper.style.position = 'relative';
      chartWrapper.style.height = '400px';
      chartWrapper.appendChild(newCanvas);

      container.innerHTML = `<h2>Doanh Thu Theo Khung Gi·ªù</h2>`;
      container.appendChild(chartWrapper);

      const ctx = newCanvas.getContext('2d');
      if (!ctx) {
        console.error('Canvas context not found');
        return;
      }

      // ƒê√°nh d·∫•u l√† ƒëang t·∫°o chart
      peakHourChartCreated = true;

      // H·ªßy chart c≈© n·∫øu c√≥
      if (window.peakHourChart && typeof window.peakHourChart.destroy === 'function') {
        window.peakHourChart.destroy();
        window.peakHourChart = null;
      }

      // X·ª≠ l√Ω d·ªØ li·ªáu
      let labels = [];
      let dataValues = [];

      if (peakHourData && Array.isArray(peakHourData) && peakHourData.length > 0) {
        labels = peakHourData.map(item => item.timeSlot || '');
        dataValues = peakHourData.map(item => parseFloat(item.totalRevenue) || 0);
      } else {
        // D·ªØ li·ªáu m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
        labels = ['08:00-11:00', '11:00-14:00', '14:00-17:00', '17:00-20:00', '20:00-23:00'];
        dataValues = [0, 0, 0, 0, 0];
      }

      console.log('Processed Labels:', labels);
      console.log('Processed Data Values:', dataValues);

      // T·∫°o m√†u s·∫Øc gradient
      const maxValue = Math.max(...dataValues);
      const colors = dataValues.map(value => {
        if (value === 0) return '#e5e7eb'; // M√†u x√°m nh·∫°t cho gi√° tr·ªã 0
        const intensity = maxValue > 0 ? (value / maxValue) : 0;
        const opacity = Math.max(0.3, Math.min(0.9, intensity));
        return `rgba(239, 68, 68, ${opacity})`; // M√†u ƒë·ªè v·ªõi ƒë·ªô trong su·ªët thay ƒë·ªïi
      });

      try {
        // T·∫°o chart v·ªõi c·∫•u h√¨nh t·ªëi ∆∞u
        window.peakHourChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Doanh thu (VNƒê)',
              data: dataValues,
              backgroundColor: colors,
              borderColor: '#ef4444',
              borderWidth: 1,
              borderRadius: 4,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false, // T·∫Øt ho√†n to√†n animation ƒë·ªÉ tr√°nh l·∫∑p
            interaction: {
              intersect: false,
              mode: 'index'
            },
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: 'Doanh Thu Theo Khung Gi·ªù',
                font: {
                  size: 16,
                  weight: 'bold'
                },
                padding: 20
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const value = context.parsed.y;
                    return `Doanh thu: ${new Intl.NumberFormat('vi-VN').format(value)} VNƒê`;
                  }
                }
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Khung gi·ªù',
                  font: {
                    size: 12,
                    weight: 'bold'
                  }
                },
                grid: {
                  display: false
                }
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Doanh thu (VNƒê)',
                  font: {
                    size: 12,
                    weight: 'bold'
                  }
                },
                ticks: {
                  callback: function (value) {
                    return new Intl.NumberFormat('vi-VN').format(value);
                  }
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              }
            }
          }
        });

        console.log('Peak Hour Chart created successfully');

      } catch (error) {
        console.error('Error creating peak hour chart:', error);
        peakHourChartCreated = false; // Reset flag n·∫øu c√≥ l·ªói
      }
    }

    // H√†m reset chart (c√≥ th·ªÉ d√πng khi c·∫ßn update d·ªØ li·ªáu)
    function resetPeakHourChart() {
      peakHourChartCreated = false;
      if (window.peakHourChart && typeof window.peakHourChart.destroy === 'function') {
        window.peakHourChart.destroy();
        window.peakHourChart = null;
      }
    }

    // Ch·ªâ ch·∫°y m·ªôt l·∫ßn duy nh·∫•t khi DOM s·∫µn s√†ng
    function initializePeakHourChart() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
          // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o t·∫•t c·∫£ script kh√°c ƒë√£ load xong
          setTimeout(createPeakHourHeatMap, 100);
        });
      } else {
        // DOM ƒë√£ s·∫µn s√†ng
        setTimeout(createPeakHourHeatMap, 100);
      }
    }

    // Kh·ªüi t·∫°o chart
    initializePeakHourChart();
  </script>
<!--  doanh thu th·ªÉ lo·∫°i-->
  <script th:inline="javascript">
    /*<![CDATA[*/
    var genreRevenues = /*[[${genreRevenues}]]*/[];
    /*]]>*/

    document.addEventListener('DOMContentLoaded', function () {
      const ctx = document.getElementById('genreRevenueChart');
      if (!ctx) {
        console.warn("Canvas for genre chart not found.");
        return;
      }

      const labels = genreRevenues.map(item => item.genreName);
      const data = genreRevenues.map(item => parseFloat(item.totalRevenue || 0));

      const backgroundColors = labels.map((_, i) =>
              `hsl(${(i * 40) % 360}, 70%, 60%)`
      );

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Doanh thu (VNƒê)',
            data: data,
            backgroundColor: backgroundColors,
            borderRadius: 5
          }]
        },
        options: {
          indexAxis: 'y', // üî• Bi·ªÉu ƒë·ªì c·ªôt ngang
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: 'Doanh thu theo th·ªÉ lo·∫°i',
              font: {
                size: 18,
                weight: 'bold'
              }
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const value = context.parsed.x;
                  return 'Doanh thu: ' + new Intl.NumberFormat('vi-VN').format(value) + ' ƒë';
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                callback: function (value) {
                  return new Intl.NumberFormat('vi-VN').format(value);
                }
              },
              title: {
                display: true,
                text: 'Doanh thu (VNƒê)',
                font: { weight: 'bold' }
              }
            },
            y: {
              title: {
                display: true,
                text: 'Th·ªÉ lo·∫°i',
                font: { weight: 'bold' }
              }
            }
          }
        }
      });
    });
  </script>
<!--  xu·∫•t excel-->
  <script>
    function toggleFilterFields() {
      const type = document.getElementById('filterType').value;

      // ·∫®n to√†n b·ªô c√°c v√πng nh·∫≠p
      document.querySelectorAll('.filter').forEach(el => el.style.display = 'none');

      switch (type) {
        case 'day':
          document.getElementById('dayInput').style.display = 'block';
          break;
        case 'range':
          document.getElementById('rangeInput').style.display = 'block';
          break;
        case 'year':
          document.getElementById('yearInput').style.display = 'block';
          // T·ª± ƒë·ªông set nƒÉm hi·ªán t·∫°i n·∫øu ch∆∞a c√≥ gi√° tr·ªã
          const yearInput = document.getElementById('yearValue');
          if (!yearInput.value) {
            const currentYear = new Date().getFullYear();
            yearInput.value = currentYear;
          }
          break;
              // C√°c tr∆∞·ªùng h·ª£p "month" v√† "week" kh√¥ng hi·ªÉn th·ªã input
        default:
          break;
      }
    }

    // G·ªçi khi trang load
    document.addEventListener("DOMContentLoaded", toggleFilterFields);
    document.getElementById("filterType").addEventListener("change", toggleFilterFields);
  </script>

</div>
</body>
</html>
