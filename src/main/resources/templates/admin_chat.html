<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf != null} ? ${_csrf.token} : ''"/>
    <meta name="_csrf_header" th:content="${_csrf != null} ? ${_csrf.headerName} : ''"/>
    <meta name="account-id" th:content="${accountId != null} ? ${accountId} : ''"/>
    <title>Chat Hỗ Trợ - Admin</title>
    <link rel="stylesheet" th:href="@{/css/chat.css}">
    <link rel="stylesheet" th:href="@{/css/layout/layout.css}">
    <link rel="apple-touch-icon" sizes="180x180" th:href="@{/favicon/apple-touch-icon.png}">
    <link rel="icon" type="image/png" sizes="32x32" th:href="@{/favicon/favicon-32x32.png}">
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/favicon/favicon-16x16.png}">
    <link rel="manifest" th:href="@{/favicon/site.webmanifest}">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon/favicon.ico}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script th:src="@{/js/websocketNotifications.js}"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
</head>
<body>
<div class="container py-5">
    <h1 class="text-center fw-bold mb-4">
        <i class="fas fa-headset me-2"></i>Chat Hỗ Trợ - Admin
    </h1>
    <div class="row g-4">
        <form id="logoutForm" method="post" th:action="@{/logout}" class="dropdown-item">
            <input type="hidden" th:name="${_csrf != null} ? ${_csrf.parameterName} : ''" th:value="${_csrf != null} ? ${_csrf.token} : ''"/>
            <button type="submit" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Đăng Xuất</span>
            </button>
        </form>
        <!-- Sidebar - Danh sách khách hàng -->
        <a href="/chat/history" class="btn btn-secondary">
            <i class="fas fa-history me-1"></i> Xem lịch sử đã kết thúc
        </a>

        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title fw-bold mb-3">
                        <i class="fas fa-users me-2"></i>Danh Sách Người Dùng Cần Hỗ Trợ
                        <span class="badge bg-warning text-dark ms-2" th:text="${#lists.size(dialogues)}">0</span>
                    </h5>
                    <div class="customer-list">
                        <div th:if="${dialogues.isEmpty()}" class="empty-state">
                            <i class="fas fa-comments"></i>
                            <p>Chưa có cuộc hội thoại nào</p>
                            <small>Khách hàng sẽ xuất hiện khi cần hỗ trợ</small>
                        </div>
                        <div th:unless="${dialogues.isEmpty()}" th:each="dialogue, stat : ${dialogues}">
                            <div class="customer-list-item" th:classappend="${dialogue.dialogueId == selectedDialogue?.dialogueId} ? 'active' : ''">
                                <div class="customer-info">
                                    <div class="customer-avatar" th:text="${stat.count}">1</div>
                                    <div class="customer-details">
                                        <p class="customer-name" th:text="${dialogue.customerName ?: 'Khách hàng #' + (dialogue.user1Id == account.accountId ? dialogue.user2Id : dialogue.user1Id)}">Unknown User</p>
                                        <p class="customer-status">
                                            <i class="fas fa-circle text-success me-1"></i>Đang chờ hỗ trợ
                                        </p>
                                        <p class="customer-time" th:text="${#dates.format(dialogue.createdAt, 'HH:mm - dd/MM')}">Vừa xong</p>
                                    </div>
                                </div>
                                <div class="customer-actions">
                                    <div th:if="${dialogue.hasUnreadMessages}" class="unread-badge" title="Tin nhắn mới">
                                        <i class="fas fa-exclamation"></i>
                                    </div>
                                    <button class="end-chat-btn" th:onclick="'endChat(' + ${dialogue.dialogueId} + ')'" title="Kết thúc chat">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <a th:href="@{/chat(dialogueId=${dialogue.dialogueId})}" class="stretched-link"></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                    <!-- Chat Header -->
                    <div class="chat-header">
                        <h5 class="card-title fw-bold mb-0">
                            <span th:if="${selectedDialogue != null}">
                                <i class="fas fa-comment-dots me-2"></i>Chat với
                                <span class="text-warning" th:text="${selectedDialogue.customerName ?: 'Khách hàng #' + (selectedDialogue.user1Id == account.accountId ? selectedDialogue.user2Id : selectedDialogue.user1Id)}">Unknown User</span>
                            </span>
                            <span th:unless="${selectedDialogue != null}">
                                <i class="fas fa-comment-alt me-2"></i>Chọn một cuộc hội thoại
                            </span>
                        </h5>
                        <div th:if="${selectedDialogue != null}" class="chat-actions">
                            <button class="btn btn-sm" th:onclick="'endChat(' + ${selectedDialogue.dialogueId} + ')'" title="Kết thúc cuộc hội thoại">
                                <i class="fas fa-sign-out-alt me-1"></i>Kết thúc
                            </button>
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div id="chatMessages" class="chat-messages flex-grow-1 mb-3">
                        <div th:if="${selectedDialogue == null}" class="welcome-screen">
                            <div class="welcome-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h4>Chào mừng đến với Chat Hỗ Trợ</h4>
                            <p class="mb-4">Vui lòng chọn một cuộc hội thoại để bắt đầu chat với khách hàng.</p>
                            <div class="welcome-tips">
                                <div class="row">
                                    <div class="col-4">
                                        <div class="tip-item">
                                            <i class="fas fa-image"></i>
                                            <p>Gửi ảnh</p>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="tip-item">
                                            <i class="fas fa-smile"></i>
                                            <p>Sử dụng emoji</p>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="tip-item">
                                            <i class="fas fa-bolt"></i>
                                            <p>Phản hồi nhanh</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div th:if="${selectedDialogue}">
                            <input type="hidden" id="dialogueId" th:value="${selectedDialogue.dialogueId}">
                            <input type="hidden" id="accountId" th:value="${account.accountId}">
                            <div th:each="chat : ${chats}" class="message"
                                 th:classappend="${chat.senderId == account.accountId} ? 'user-message' : 'support-message'">
                                <div th:if="${chat.messageContent.startsWith('IMAGE:')}" class="image-container">
                                    <img th:src="${#strings.substring(chat.messageContent, 6)}"
                                         class="chat-image"
                                         th:onclick="'openImageModal(\'' + ${#strings.substring(chat.messageContent, 6)} + '\')'">
                                </div>
                                <div th:unless="${chat.messageContent.startsWith('IMAGE:')}" th:text="${chat.messageContent}"></div>
                                <div class="message-time" th:text="${#dates.format(chat.sentAt, 'HH:mm')}"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <form id="chatForm" class="chat-input" th:if="${selectedDialogue}">
                        <div class="input-group">
                            <textarea id="messageContent" class="form-control" placeholder="Nhập tin nhắn..." rows="1"></textarea>
                            <input type="file" id="fileInput" class="form-control d-none" accept="image/*">
                            <label for="fileInput" class="btn btn-link px-3" title="Gửi ảnh">
                                <i class="fas fa-image" style="font-size: 18px; color: #f9a825;"></i>
                            </label>
                            <button type="button" id="emojiBtn" class="btn btn-link px-3" title="Chọn emoji">
                                <i class="fas fa-smile" style="font-size: 18px; color: #f9a825;"></i>
                            </button>
                            <input type="hidden" id="dialogueId" th:value="${selectedDialogue.dialogueId}">
                            <input type="hidden" id="accountId" th:value="${account.accountId}">
                            <button type="submit" class="btn btn-warning px-4">
                                <i class="fas fa-paper-plane me-2"></i>Gửi
                            </button>
                        </div>
                        <div id="emojiPicker" class="emoji-picker" style="display: none;">
                            <div class="emoji-header">
                                <span>Chọn emoji</span>
                                <button type="button" class="emoji-close">&times;</button>
                            </div>
                            <emoji-picker id="emojiPicker" style="display:none; position:absolute; z-index:1000;"></emoji-picker>
                        </div>
                        <div class="quick-responses">
                            <span class="quick-response-btn" data-message="Xin chào! Tôi có thể giúp gì cho bạn?">Chào hỏi</span>
                            <span class="quick-response-btn" data-message="Cảm ơn bạn đã liên hệ!">Cảm ơn</span>
                            <span class="quick-response-btn" data-message="Vui lòng chờ trong giây lát...">Chờ chút</span>
                            <span class="quick-response-btn" data-message="Có vấn đề gì khác không?">Hỗ trợ thêm</span>
                            <span class="quick-response-btn" data-message="Nếu bạn không còn vấn đề gì nữa thì mình xin kết thúc cuộc trò chuyện tại đây!">Kết thúc</span>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal">
    <span class="image-modal-close">&times;</span>
    <div class="image-modal-content">
        <img id="modalImage" src="" alt="Image">
        <div class="image-modal-info">
            <p>Click để đóng hoặc nhấn ESC</p>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@6.1.2/bundles/stomp.umd.min.js"></script>
    <script src="/js/chat.js"></script>
    <script>
        const accountId = /*[[${account.accountId}]]*/ 0;
        const dialogueId = /*[[${selectedDialogue?.dialogueId}]]*/ null;
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

    // Show/hide emoji picker
    document.getElementById('emojiBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        const picker = document.getElementById('emojiPicker');
        picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
        // Position picker if needed
        picker.style.position = 'absolute';
        picker.style.bottom = '60px';
    });

    // Insert emoji into textarea
    document.getElementById('emojiPicker')?.addEventListener('emoji-click', function(event) {
        const textarea = document.getElementById('messageContent');
        if (textarea) {
            textarea.value += event.detail.unicode;
            textarea.focus();
        }
        this.style.display = 'none';
    });

    // Hide picker when clicking outside
    document.addEventListener('click', function(e) {
        const picker = document.getElementById('emojiPicker');
        const btn = document.getElementById('emojiBtn');
        if (picker && btn && !picker.contains(e.target) && !btn.contains(e.target)) {
            picker.style.display = 'none';
        }
    });

    document.getElementById('emojiBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        const emojiPicker = document.getElementById('emojiPicker');
        emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
    });

    document.querySelector('.emoji-close')?.addEventListener('click', function() {
        document.getElementById('emojiPicker').style.display = 'none';
    });

    document.querySelectorAll('.emoji-item').forEach(emoji => {
        emoji.addEventListener('click', function() {
            document.getElementById('messageContent').value += this.textContent;
            document.getElementById('emojiPicker').style.display = 'none';
            document.getElementById('messageContent').focus();
        });
    });

    document.querySelectorAll('.quick-response-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('messageContent').value = this.getAttribute('data-message');
            document.getElementById('messageContent').focus();
        });
    });

    document.addEventListener('click', function(e) {
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiBtn = document.getElementById('emojiBtn');
        if (emojiPicker && emojiBtn && !emojiPicker.contains(e.target) && !emojiBtn.contains(e.target)) {
            emojiPicker.style.display = 'none';
        }
    });

    function openImageModal(imageSrc) {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        modal.style.display = 'block';
        modalImg.src = imageSrc;
        document.body.style.overflow = 'hidden';
    }

    document.querySelector('.image-modal-close')?.addEventListener('click', function() {
        document.getElementById('imageModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    });

    document.getElementById('imageModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.getElementById('imageModal').style.display = 'none';
            document.getElementById('emojiPicker').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    });

    function endChat(dialogueId) {
        if (confirm('Bạn có chắc chắn muốn kết thúc cuộc hội thoại này?')) {
            fetch(`/chat/end/${dialogueId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data && data.status === 'success') {
                        alert('Đã kết thúc cuộc hội thoại thành công');
                        setTimeout(() => window.location.href = '/chat', 1000);
                    } else {
                        alert(data.message || 'Có lỗi xảy ra khi kết thúc cuộc hội thoại');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra: ' + error.message);
                });
        }
    }

    function clearChat() {
        if (confirm('Bạn có chắc chắn muốn xóa lịch sử chat?')) {
            // Implement clear chat logic (e.g., API call)
            alert('Chức năng xóa chưa được triển khai');
        }
    }

    document.getElementById('messageContent')?.addEventListener('paste', function(e) {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                const file = new File([blob], 'pasted-image.png', { type: blob.type });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById('fileInput').files = dataTransfer.files;
                alert('Ảnh đã được dán, nhấn Gửi để gửi tin nhắn');
                e.preventDefault();
                break;
            }
        }
    });

    const dropZones = [document.getElementById('chatMessages'), document.getElementById('messageContent')];
    dropZones.forEach(element => {
        if (!element) return;
        element.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.add('drag-over');
        });
        element.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');
        });
        element.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(files[0]);
                document.getElementById('fileInput').files = dataTransfer.files;
                alert('Ảnh đã được thả, nhấn Gửi để gửi tin nhắn');
            }
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>