<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <title layout:title-pattern="User Profile" th:text="#{profile}">User Profile - Top1Cinema</title>
    <link rel="stylesheet" th:href="@{/css/utilities/nightEffect.css}">
    <link rel="apple-touch-icon" sizes="180x180" th:href="@{/favicon/apple-touch-icon.png}">
    <link rel="icon" type="image/png" sizes="32x32" th:href="@{/favicon/favicon-32x32.png}">
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/favicon/favicon-16x16.png}">
    <link rel="manifest" th:href="@{/favicon/site.webmanifest}">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon/favicon.ico}">
    <!-- Thymeleaf fragments for styles -->    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/userProfile.css}">
    <link rel="stylesheet" th:href="@{css/lightMode/theme.css}">

    <!-- Custom JavaScript -->
    <script th:src="@{/js/userProfile.js}" defer></script>
</head>
<body>
<!-- Main Content -->
<div layout:fragment="content" class="min-h-screen">
    <main class="pt-5 mt-4">
        <div class="moon-background">
            <div class="moon"></div>
            <div class="stars">
                <div class="star"></div>
                <div class="star"></div>
                <div class="star"></div>
                <div class="star"></div>
                <div class="star"></div>
            </div>
            <div class="night-clouds">
                <div class="cloud"></div>
                <div class="cloud"></div>
            </div>
            <div class="night-overlay"></div>
        </div>

        <div class="background-elements"></div>

        <div class="container py-4" th:object="${accountProfile}">            <!-- Enhanced Profile Header Card -->
            <div class="card profile-header-card mb-4">
                <div class="card-body p-4 p-md-5">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center mb-4 mb-md-0">
                            <div class="position-relative d-inline-block avatar-container" style="position: relative;">
                                <form id="uploadForm" th:action="@{/profile/upload-image}" method="post"
                                      enctype="multipart/form-data">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <img th:src="${accountProfile.avatarUrl != null ? accountProfile.avatarUrl : 'http://res.cloudinary.com/dycfyoh8r/image/upload/v1753341911/avatars/avatar_default'}"
                                         alt="Profile Avatar"
                                         id="profileAvatar"
                                         style="color: white"
                                         class="profile-avatar">
                                    <div class="form-group d-flex align-items-center gap-2 mb-2">
                                        <label for="imageInput" class="mb-0 text-custom-yellow fw-semibold"
                                               th:text="#{profile.choose_image}">Chọn hình ảnh:</label>
                                        <input type="file" id="imageInput" name="image" accept="image/*"
                                               class="form-control form-control-sm bg-dark text-white border-0"
                                               style="max-width: 220px;" onchange="previewImage(event,this)">
                                    </div>
                                    <button type="submit" class="btn btn-warning btn-sm px-3 py-1 mt-2"
                                            th:text="#{profile.upload}">Upload
                                    </button>
                                </form>

                            </div>
                        </div>
                        <div class="col-md-6">
                            <h1 class="text-white fw-bold display-6 mb-2 profile-name" id="displayName"
                                th:text="${accountProfile.fullName}">
                                <span th:text="#{profile.personal_info}">User Name</span></h1>
                            <p class="text-custom-yellow fs-5 mb-2 profile-username" id="displayUsername"
                               th:text="${accountProfile.username}">username</p>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                <span class="badge bg-success text-white px-3 py-2">
                                    <i class="fas fa-check-circle me-1"></i><span th:text="#{profile.active_account}">Active Account</span>
                                </span>
                                <span class="badge bg-info text-white px-3 py-2"
                                      th:text="${accountProfile.role.name().toUpperCase() ?: 'member'}">
                                    <i class="fas fa-user-tag me-1"></i><span th:text="#{profile.member}">Member</span>
                                </span>
                            </div>
                            <p class="text-white-50 mb-3">
                                <i class="fas fa-calendar-alt me-2 text-custom-yellow"></i>
                                <span th:text="#{profile.member_since}">Member since:</span> <span
                                    th:text="${accountProfile.registerDate != null ? #temporals.format(accountProfile.registerDate, 'MM yyyy ') : 'Feb 20 2008' }"
                            >Feb 20 2009</span>
                            </p>
                        </div>
                        <div class="col-md-3">
                            <div class="row g-2">
                                <div class="col-4 col-md-12">
                                    <div class="card stat-card text-center p-3 h-100">
                                        <div class="display-6 fw-bold text-custom-yellow" id="totalBookingsCount">0
                                        </div>
                                        <div class="text-white-50 small" th:text="#{profile.total_bookings}">Total
                                            Bookings
                                        </div>
                                    </div>
                                </div>
                                <div class="col-4 col-md-12">
                                    <div class="card stat-card text-center p-3 h-100">
                                        <div class="display-6 fw-bold text-success" id="monthlyBookingsCount">0</div>
                                        <div class="text-white-50 small" th:text="#{profile.this_month}">This Month
                                        </div>
                                    </div>
                                </div>
                                <div class="col-4 col-md-12">
                                    <div class="card stat-card text-center p-3 h-100">
                                        <div class="display-6 fw-bold text-warning" id="totalSpentAmount">0</div>
                                        <div class="text-white-50 small" th:text="#{profile.total_spent}">Total Spent
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Tab Navigation -->
            <div class="card tab-navigation-card mb-4">
                <div class="card-body p-0">
                    <nav class="nav nav-pills nav-fill p-3">
                        <button class="nav-link active btn-tab-custom mx-1 py-3"
                                onclick="showTab('personal-info')"
                                data-tab="personal-info"
                                style="color: white;">
                            <i class="fas fa-user me-2"></i>
                            <span class="d-none d-sm-inline"
                                  th:text="#{profile.personal_info}">Personal Information</span>
                            <span class="d-sm-none" th:text="#{profile.info}">Info</span>
                        </button>

                        <!--                        <button class="nav-link text-white btn-tab-custom mx-1 py-3"-->
                        <!--                                onclick="showTab('booking-history')"-->
                        <!--                                data-tab="booking-history">-->
                        <!--                            <i class="fas fa-history me-2"></i>-->
                        <!--                            <span class="d-none d-sm-inline" th:text="#{profile.booking_history}">Booking History</span>-->
                        <!--                            <span class="d-sm-none" th:text="#{profile.history}">History</span>-->
                        <!--                        </button>-->
                        <!--                        <button class="nav-link text-white btn-tab-custom mx-1 py-3"-->
                        <!--                                onclick="showTab('score-history')"-->
                        <!--                                data-tab="score-history">-->
                        <!--                            <i class="fas fa-star me-2"></i>-->
                        <!--                            <span class="d-none d-sm-inline">History</span>-->
                        <!--                            <span class="d-sm-none">History</span>-->
                        <!--                        </button>-->

                        <button class="nav-link text-white btn-tab-custom mx-1 py-3"
                                onclick="showTab('booked-tickets')"
                                data-tab="booked-tickets">
                            <i class="fas fa-ticket-alt me-2"></i>
                            <span class="d-none d-sm-inline">Booked Tickets</span>
                            <span class="d-sm-none">Booked</span>
                        </button>
                        <!--                        <button class="nav-link text-white btn-tab-custom mx-1 py-3"-->
                        <!--                                onclick="showTab('canceled-tickets')"-->
                        <!--                                data-tab="canceled-tickets">-->
                        <!--                            <i class="fas fa-times-circle me-2"></i>-->
                        <!--                            <span class="d-none d-sm-inline">Canceled Tickets</span>-->
                        <!--                            <span class="d-sm-none">Canceled</span>-->
                        <!--                        </button>-->
                        <button class="nav-link text-white btn-tab-custom mx-1 py-3"
                                onclick="showTab('change-password')"
                                data-tab="change-password">
                            <i class="fas fa-key me-2"></i>
                            <span class="d-none d-sm-inline" th:text="#{profile.change_password}">Change Password</span>
                            <span class="d-sm-none" th:text="#{profile.password}">Password</span>
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Personal Information Tab -->
                <div id="personal-info" class="tab-pane fade show active">
                    <div class="card content-card">
                        <div class="card-header bg-transparent border-0">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                                <h2 class="text-white mb-0">
                                    <i class="fas fa-user-edit me-2 text-custom-yellow"></i><span
                                        th:text="#{profile.personal_info}">Personal Information</span>
                                    <small class="text-lg fs-6 d-block" th:text="#{profile.view_and_manage}">View and
                                        manage your profile details</small>
                                </h2>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-warning btn-sm"
                                            onclick="calculateProfileCompleteness()" title="Refresh Profile Status">
                                        <i class="fas fa-sync-alt me-1"></i> <span
                                            th:text="#{profile.refresh}">Refresh</span>
                                    </button>
                                    <button class="btn btn-warning" id="editBtn" onclick="toggleEditMode()">
                                        <i class="fas fa-edit me-1"></i>
                                        <span class="d-none d-sm-inline"
                                              th:text="#{profile.edit_profile}">Edit Profile</span>
                                        <span class="d-sm-none" th:text="#{profile.edit}">Edit</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Display Mode -->
                            <div id="displayMode" class="info-display">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="card info-display-card h-100">
                                            <div class="card-body">
                                                <label class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                    <i class="fas fa-user me-2"></i> <span
                                                        th:text="#{profile.fullName}">Full Name</span>
                                                </label>
                                                <div class="text-white fs-5" id="displayFullName">
                                                    <span th:if="${accountProfile.fullName != null and !#strings.isEmpty(accountProfile.fullName)}"
                                                          th:text="${accountProfile.fullName}"></span>
                                                    <span th:unless="${accountProfile.fullName != null and !#strings.isEmpty(accountProfile.fullName)}"
                                                          th:text="#{profile.not_provided}"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card info-display-card h-100">
                                            <div class="card-body">
                                                <label class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                    <i class="fas fa-envelope me-2"></i> <span
                                                        th:text="#{profile.mailAddress}">Email Address</span>
                                                </label>
                                                <div class="text-white fs-5" id="displayEmail"
                                                     th:text="${accountProfile.email}">email@example.com
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="card info-display-card h-100">
                                            <div class="card-body">
                                                <label class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                    <i class="fas fa-birthday-cake me-2"></i> <span
                                                        th:text="#{profile.dateOfBirth}">Date of Birth</span>
                                                </label>
                                                <div class="text-white fs-5" id="displayBirthDate">
                                                    <span th:if="${accountProfile.dateOfBirth != null}"
                                                          th:text="${#temporals.format(accountProfile.dateOfBirth, 'dd/MM/yyyy')}"></span>
                                                    <span th:unless="${accountProfile.dateOfBirth != null}"
                                                          th:text="#{profile.not_provided}"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card info-display-card h-100">
                                            <div class="card-body">
                                                <label class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                    <i class="fas fa-venus-mars me-2"></i> <span
                                                        th:text="#{profile.gender}">Gender</span>
                                                </label>
                                                <div class="text-white fs-5" id="displayGender">
                                            <span th:if="${accountProfile.gender == 'M'}"
                                                  class="badge bg-info fs-6">
                                                <i class="fas fa-mars me-1 text-white fs-5"></i> <span
                                                    th:text="#{profile.male}">Male</span>
                                            </span>
                                                    <span th:if="${accountProfile.gender == 'F'}"
                                                          class="badge bg-warning fs-6">
                                                <i class="fas fa-venus me-1 text-white fs-5"></i> <span
                                                            th:text="#{profile.female}">Female</span>
                                            </span>
                                                    <span th:if="${accountProfile.gender == null or accountProfile.gender == ''}"
                                                          class="text-white fs-5">
                                                <span th:text="#{profile.not_specified}">Not specified</span>
                                            </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card info-display-card h-100">
                                            <div class="card-body">
                                                <label class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                    <i class="fas fa-phone me-2"></i> <span
                                                        th:text="#{profile.phoneNumber}">Phone Number</span>
                                                </label>
                                                <div class="text-white fs-5" id="displayPhone">
                                                    <span th:if="${accountProfile.phoneNumber != null and !#strings.isEmpty(accountProfile.phoneNumber)}"
                                                          th:text="${accountProfile.phoneNumber}"></span>
                                                    <span th:unless="${accountProfile.phoneNumber != null and !#strings.isEmpty(accountProfile.phoneNumber)}"
                                                          th:text="#{profile.not_provided}"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card info-display-card h-100">
                                            <div class="card-body">
                                                <label class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                    <i class="fas fa-id-card me-2"></i> <span
                                                        th:text="#{profile.idNumber}">Citizen ID</span>
                                                </label>
                                                <div class="text-white fs-5" id="displayCitizenId">
                                                    <span th:if="${accountProfile.identityCard != null and !#strings.isEmpty(accountProfile.identityCard)}"
                                                          th:text="${accountProfile.identityCard}"></span>
                                                    <span th:unless="${accountProfile.identityCard != null and !#strings.isEmpty(accountProfile.identityCard)}"
                                                          th:text="#{profile.not_provided}"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <div class="card info-display-card">
                                            <div class="card-body">
                                                <label class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                    <i class="fas fa-map-marker-alt me-2"></i> <span
                                                        th:text="#{profile.address}">Address</span>
                                                </label>
                                                <div class="text-white fs-5" id="displayAddress">
                                                    <span th:if="${accountProfile.address != null and !#strings.isEmpty(accountProfile.address)}"
                                                          th:text="${accountProfile.address}"></span>
                                                    <span th:unless="${accountProfile.address != null and !#strings.isEmpty(accountProfile.address)}"
                                                          th:text="#{profile.not_provided}"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Profile Completeness & Security Info -->
                                <div class="row g-4 mt-2">
                                    <div class="col-12">
                                        <div class="card info-display-card">
                                            <div class="card-body">
                                                <h5 class="text-custom-yellow mb-3">
                                                    <i class="fas fa-shield-alt me-2"></i> <span
                                                        th:text="#{profile.personal_info}">Profile Information
                                                        Summary</span>
                                                </h5>
                                                <div class="row text-center">
                                                    <div class="col-md-3 col-6 mb-3">
                                                        <div class="fs-4" id="profileCompleteness">0%</div>
                                                        <small class="text-white fs-5"
                                                               th:text="#{profile.profile_complete}">Profile
                                                            Complete</small>
                                                    </div>
                                                    <div class="col-md-3 col-6 mb-3">
                                                        <div class="text-success fs-4">
                                                            <i class="fas fa-check-circle"></i>
                                                        </div>
                                                        <small class="text-white fs-5"
                                                               th:text="#{profile.email_verified}">Email
                                                            Verified</small>
                                                    </div>
                                                    <div class="col-md-3 col-6 mb-3">
                                                        <div class="text-warning fs-4">
                                                            <span th:text="${accountProfile.phoneNumber != null and accountProfile.phoneNumber != '' ? '✓' : '⚠'}">⚠</span>
                                                        </div>
                                                        <small class=" text-white fs-5"
                                                               th:text="#{profile.phoneNumber}">Phone Status</small>
                                                    </div>
                                                    <div class="col-md-3 col-6 mb-3">
                                                        <div class="text-info fs-4">
                                                            <i class="fas fa-calendar-check"></i>
                                                        </div>
                                                        <small class="text-white fs-5"
                                                               th:text="#{profile.account_active}">Account
                                                            Active</small>
                                                    </div>
                                                </div>
                                                <div class="alert alert-info mt-3 security-tip">
                                                    <i class="fas fa-lightbulb me-2"></i>
                                                    <span th:text="#{profile.view_and_manage}">Keep your profile information up to date for better security and
                                                        personalized experience.</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Edit Mode -->
                            <div id="editMode" class="info-edit" style="display: none;">
                                <form id="profileForm" method="post" th:action="@{/profile/update}">
                                    <input type="hidden" th:field="*{username}"/>
                                    <div class="row g-4">
                                        <div class="col-md-6">
                                            <div class="card info-display-card h-100">
                                                <div class="card-body">
                                                    <label for="fullName"
                                                           class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                        <i class="fas fa-user me-2"></i> Full Name *
                                                    </label>
                                                    <input type="text"
                                                           class="form-control form-control-dark bg-dark text-white"
                                                           id="fullName" name="fullName"
                                                           placeholder="Enter your full name"
                                                           th:value="${accountProfile.fullName}">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card info-display-card h-100">
                                                <div class="card-body">
                                                    <label for="email"
                                                           class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                        <i class="fas fa-envelope me-2"></i> Email Address *
                                                    </label>
                                                    <input type="text"
                                                           class="form-control form-control-dark bg-dark text-white"
                                                           id="email" name="email" required
                                                           placeholder="Enter your email"
                                                           th:value="${accountProfile.email}">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card info-display-card h-100">
                                                <div class="card-body">
                                                    <label for="birthDate"
                                                           class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                        <i class="fas fa-birthday-cake me-2"></i> Date of Birth
                                                    </label>
                                                    <input type="date"
                                                           class="form-control form-control-dark bg-dark text-white"
                                                           id="birthDate" name="dateOfBirth"
                                                           th:value="${accountProfile.dateOfBirth}">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card info-display-card h-100">
                                                <div class="card-body">
                                                    <label for="gender"
                                                           class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                        <i class="fas fa-venus-mars me-2"></i> Gender (Sex)
                                                    </label>
                                                    <select class="form-select form-control-dark bg-dark text-white"
                                                            id="gender" name="gender">
                                                        <option value=""
                                                                th:selected="${accountProfile.gender == null or accountProfile.gender == ''}">
                                                            Not specified
                                                        </option>
                                                        <option value="M" th:selected="${accountProfile.gender == 'M'}">
                                                            Male
                                                        </option>
                                                        <option value="F" th:selected="${accountProfile.gender == 'F'}">
                                                            Female
                                                        </option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card info-display-card h-100">
                                                <div class="card-body">
                                                    <label for="phone"
                                                           class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                        <i class="fas fa-phone me-2"></i> Phone Number
                                                    </label>
                                                    <input type="tel"
                                                           class="form-control form-control-dark bg-dark text-white"
                                                           id="phone" name="phoneNumber"
                                                           placeholder="Enter your phone number"
                                                           th:value="${accountProfile.phoneNumber}">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card info-display-card h-100">
                                                <div class="card-body">
                                                    <label for="citizenId"
                                                           class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                        <i class="fas fa-id-card me-2"></i> Citizen ID
                                                    </label>
                                                    <input type="text"
                                                           class="form-control form-control-dark bg-dark text-white"
                                                           id="citizenId" name="identityCard"
                                                           placeholder="Enter your citizen ID"
                                                           th:value="${accountProfile.identityCard}">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="card info-display-card">
                                                <div class="card-body">
                                                    <label for="address"
                                                           class="text-custom-yellow fw-semibold d-flex align-items-center mb-2">
                                                        <i class="fas fa-map-marker-alt me-2"></i> Address
                                                    </label>
                                                    <textarea class="form-control form-control-dark bg-dark text-white"
                                                              id="address" name="address" rows="3"
                                                              placeholder="Enter your address"
                                                              th:text="${accountProfile.address}"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2 mt-4 justify-content-end">
                                        <button type="button" class="btn btn-danger" onclick="cancelEdit()">
                                            <i class="fas fa-times me-1"></i> <span
                                                th:text="#{button.close}">Cancel</span>
                                        </button>
                                        <button type="submit" class="btn btn-warning">
                                            <i class="fas fa-save me-1"></i> <span th:text="#{button.bookmark}">Save Changes</span>
                                        </button>
                                    </div>
                                </form>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Score History Tab -->
                <div id="score-history" class="tab-pane fade" style="display: none;">
                    <div class="card content-card">
                        <div class="card-header bg-transparent border-0">
                            <h2 class="text-white mb-0">
                                <i class="fas fa-star me-2 text-custom-yellow"></i>Lịch sử điểm thưởng
                                <small class="text-lg fs-6 d-block">Theo dõi điểm thưởng từ việc mua vé và đổi thưởng</small>
                            </h2>
                        </div>
                        <div class="card-body">
                            <!-- Nhúng bookingList vào JavaScript -->
                            <script th:inline="javascript">
                                /*[+
                                window.bookingList = [[${bookingList}]] || [];
                                console.log('Booking List:', window.bookingList);
                                +]*/
                            </script>
                            <!-- Filter Section -->
                            <div class="card mb-4" style="background: rgba(15, 23, 41, 0.8); border: 1px solid rgba(245, 158, 11, 0.2);">
                                <div class="card-header bg-transparent border-0">
                                    <h5 class="text-custom-yellow mb-0">
                                        <i class="fas fa-filter me-2"></i>Lọc lịch sử điểm thưởng
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form id="scoreFilterForm">
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label for="fromDate" class="form-label text-white fw-semibold">
                                                    <i class="fas fa-calendar-alt me-1 text-custom-yellow"></i>Từ ngày
                                                </label>
                                                <div class="date-input-container">
                                                    <input type="text" class="form-control form-control-dark bg-dark text-white"
                                                           id="fromDate" name="fromDate" placeholder="DD/MM/YYYY" maxlength="10">
                                                    <i class="fas fa-calendar-day date-icon"></i>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="toDate" class="form-label text-white fw-semibold">
                                                    <i class="fas fa-calendar-alt me-1 text-custom-yellow"></i>Đến ngày
                                                </label>
                                                <div class="date-input-container">
                                                    <input type="text" class="form-control form-control-dark bg-dark text-white"
                                                           id="toDate" name="toDate" placeholder="DD/MM/YYYY" maxlength="10">
                                                    <i class="fas fa-calendar-day date-icon"></i>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label text-white fw-semibold">
                                                    <i class="fas fa-list me-1 text-custom-yellow"></i>Loại lịch sử
                                                </label>
                                                <div class="d-flex gap-3 mt-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="historyType"
                                                               id="scoreAdding" value="adding" checked>
                                                        <label class="form-check-label text-white" for="scoreAdding">
                                                            <i class="fas fa-plus-circle text-success me-1"></i>Cộng điểm
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="historyType"
                                                               id="scoreUsing" value="using">
                                                        <label class="form-check-label text-white" for="scoreUsing">
                                                            <i class="fas fa-minus-circle text-danger me-1"></i>Sử dụng điểm
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button type="submit" class="btn btn-warning w-100">
                                                    <i class="fas fa-search me-1"></i>Xem điểm
                                                </button>
                                            </div>
                                            <div class="col-md-1 d-flex align-items-end">
                                                <button type="button" class="btn btn-outline-warning w-100" onclick="clearScoreHistoryForm()">
                                                    <i class="fas fa-eraser me-1"></i>Xóa
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <!-- Score History Results -->
                            <div id="scoreHistoryResults">
                                <!-- Loading State -->
                                <div id="loadingState" class="text-center py-5" style="display: none;">
                                    <div class="spinner-border text-warning" role="status">
                                        <span class="visually-hidden">Đang tải...</span>
                                    </div>
                                    <p class="text-white mt-3">Đang tải lịch sử điểm thưởng...</p>
                                </div>
                                <!-- No Results State -->
                                <div id="noResultsState" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-inbox fa-3x text-custom-yellow mb-3"></i>
                                    <h4 class="text-white">Không tìm thấy lịch sử điểm thưởng.</h4>
                                    <p class="text-white-50">Hãy thử điều chỉnh khoảng thời gian hoặc tiêu chí lọc.</p>
                                </div>
                                <!-- Results Table -->
                                <div id="resultsTable" style="display: none;">
                                    <div class="card" style="background: rgba(15, 23, 41, 0.8); border: 1px solid rgba(245, 158, 11, 0.2);">
                                        <div class="card-header bg-transparent border-0">
                                            <h5 class="text-white mb-0">
                                                <i class="fas fa-list-ul me-2 text-custom-yellow"></i>
                                                <span id="resultsTitle">Kết quả lịch sử điểm thưởng</span>
                                                <span class="badge bg-warning text-dark ms-2" id="resultsCount">0 bản ghi</span>
                                            </h5>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-dark table-hover mb-0">
                                                    <thead class="table-warning">
                                                    <tr>
                                                        <th scope="col" class="text-dark fw-bold">
                                                            <i class="fas fa-calendar me-1"></i>Ngày tạo
                                                        </th>
                                                        <th scope="col" class="text-dark fw-bold">
                                                            <i class="fas fa-film me-1"></i>Tên phim
                                                        </th>
                                                        <th scope="col" class="text-dark fw-bold text-center">
                                                            <i class="fas fa-star me-1"></i><span id="scoreColumnHeader">Điểm</span>
                                                        </th>
                                                    </tr>
                                                    </thead>
                                                    <tbody id="scoreHistoryTableBody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Initial State -->
                                <div id="initialState" class="text-center py-5">
                                    <i class="fas fa-star fa-3x text-custom-yellow mb-3"></i>
                                    <h4 class="text-white">Theo dõi lịch sử điểm thưởng</h4>
                                    <p class="text-white-50 mb-4">Chọn khoảng thời gian và loại lịch sử để xem hoạt động điểm thưởng của bạn.</p>
                                    <div class="row g-3 justify-content-center text-start">
                                        <div class="col-md-5">
                                            <div class="card h-100" style="background: rgba(15, 23, 41, 0.6); border: 1px solid rgba(245, 158, 11, 0.2);">
                                                <div class="card-body">
                                                    <h6 class="text-custom-yellow mb-2">
                                                        <i class="fas fa-plus-circle me-2"></i>Cộng điểm
                                                    </h6>
                                                    <p class="text-white-50 small mb-0">Điểm kiếm được từ việc đặt vé và các chương trình khuyến mãi đặc biệt</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="card h-100" style="background: rgba(15, 23, 41, 0.6); border: 1px solid rgba(245, 158, 11, 0.2);">
                                                <div class="card-body">
                                                    <h6 class="text-custom-yellow mb-2">
                                                        <i class="fas fa-minus-circle me-2"></i>Sử dụng điểm
                                                    </h6>
                                                    <p class="text-white-50 small mb-0">Điểm được sử dụng để đổi giảm giá và ưu đãi đặc biệt</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Booked Tickets Tab -->
                <div id="booked-tickets" class="tab-pane fade" style="display: none;">
                    <div class="card content-card">
                        <div class="card-header bg-transparent border-0">
                            <h2 class="text-white mb-0">
                                <i class="fas fa-ticket-alt me-2 text-custom-yellow"></i>Booked Tickets
                                <small class="text-lg fs-6 d-block">View all your confirmed movie bookings</small>
                            </h2>
                        </div>
                        <div class="card-body">
                            <!-- Search and Filter Section -->
                            <div class="mb-4">
                                <div class="card filter-form-container">
                                    <div class="card-body">
                                        <div class="row g-3 align-items-end">
                                            <div class="col-md-4">
                                                <label class="form-label text-custom-yellow fw-semibold">
                                                    <i class="fas fa-search me-1"></i>Search Tickets
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-search"></i>
                                                    </span>
                                                    <input type="text" class="form-control form-control-dark"
                                                           id="searchTicket"
                                                           placeholder="Search by movie, seat, or ticket ID..."
                                                           oninput="filterTickets()">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label text-custom-yellow fw-semibold">
                                                    <i class="fas fa-filter me-1"></i>Status
                                                </label>
                                                <select class="form-select form-control-dark" id="statusFilter" onchange="filterByStatus()">
                                                    <option value="all">All Status</option>
                                                    <option value="1">Confirmed</option>
                                                    <option value="0">Pending</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label text-custom-yellow fw-semibold">
                                                    <i class="fas fa-sort me-1"></i>Sort By
                                                </label>
                                                <select class="form-select form-control-dark" id="sortBy" onchange="sortTickets()">
                                                    <option value="date">Sort by Date</option>
                                                    <option value="movie">Sort by Movie</option>
                                                    <option value="total">Sort by Price</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="btn-group w-100" role="group">
                                                    <button class="btn btn-outline-warning" onclick="toggleSortOrder()" title="Toggle sort order">
                                                        <i class="fas fa-sort" id="sortIcon"></i> Order
                                                    </button>
                                                    <button class="btn btn-warning" onclick="clearFilters()" title="Clear all filters">
                                                        <i class="fas fa-refresh me-1"></i> Reset
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tickets List -->
                            <div class="tickets-container">
                                <!-- Nếu có dữ liệu -->
                                <div th:if="${fullBookingList != null and !fullBookingList.isEmpty()}">
                                    <div th:each="b : ${fullBookingList}" class="mb-3">
                                        <div class="card ticket-card shadow-sm"
                                             th:classappend="${b.status == 1 ? 'border-success' : (b.status == 0 ? 'border-warning' : 'border-secondary')}"
                                             th:data-status="${b.status}"
                                             th:data-movie="${b.movieName}"
                                             th:data-seats="${b.seatNumber}"
                                             th:data-ticket-id="${b.invoiceId}"
                                             th:data-show-date="${b.showDate != null ? #dates.format(b.showDate, 'yyyy-MM-dd') : ''}"
                                             th:data-schedule-time="${b.scheduleTime != null ? #dates.format(b.scheduleTime, 'HH:mm') : ''}"
                                             th:data-total-amount="${b.totalAmount}">

                                            <div class="card-body py-3">
                                                <div class="row align-items-center">
                                                    <!-- Movie Info -->
                                                    <div class="col-md-5">
                                                        <h6 class="card-title text-white fw-bold mb-2">
                                                            <i class="fas fa-film text-custom-yellow me-2"></i>
                                                            <span th:text="${b.movieName}">Movie Name</span>
                                                        </h6>
                                                        <div class="row text-muted small g-1">
                                                            <div class="col-sm-6">
                                                                <i class="fas fa-ticket-alt me-1" style="color: #007bff;"></i>
                                                                <span class="fw-medium">#<span th:text="${b.invoiceId}">12345</span></span>
                                                            </div>
                                                            <div class="col-sm-6">
                                                                <i class="fas fa-calendar-day me-1" style="color: #ffc107;"></i>
                                                                <span th:text="${b.showDate != null ? #dates.format(b.showDate, 'dd/MM/yyyy') : ''}">14/08/2025</span>
                                                            </div>
                                                            <div class="col-sm-6">
                                                                <i class="fas fa-clock me-1" style="color: #6f42c1;"></i>
                                                                <span th:text="${b.scheduleTime != null ? #dates.format(b.scheduleTime, 'HH:mm') : ''}">19:30</span>
                                                            </div>
                                                            <div class="col-sm-6">
                                                                <i class="fas fa-chair me-1" style="color: #6c757d;"></i>
                                                                <span th:text="${b.seatNumber}">A1, A2</span>
                                                            </div>
                                                            <div class="col-sm-6" th:if="${b.paymentMethod != null}">
                                                                <i class="fas fa-credit-card me-1" style="color: #28a745;"></i>
                                                                <span class="text-capitalize" th:text="${b.paymentMethod}">Online</span>
                                                            </div>
                                                        </div>

                                                        <!-- Score Info -->
                                                        <div class="mt-2" th:if="${b.useScore != null and b.useScore > 0}">
                                                            <div class="row text-muted small g-1">
                                                                <div class="col-sm-6">
                                                                    <i class="fas fa-star me-1" style="color: #e83e8c;"></i>
                                                                    <span>Dùng <span th:text="${b.useScore}">0</span> điểm</span>
                                                                </div>
                                                                <div class="col-sm-6" th:if="${b.addScore != null and b.addScore > 0}">
                                                                    <i class="fas fa-plus-circle me-1" style="color: #fd7e14;"></i>
                                                                    <span>Nhận <span th:text="${b.addScore}">0</span> điểm</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Price & Status -->
                                                    <div class="col-md-3 text-center">
                                                        <div class="price-display mb-2"
                                                             th:classappend="${b.status == 1 ? 'text-success' : (b.status == 0 ? 'text-warning' : 'text-muted')}"
                                                             th:style="'font-size: 1.25rem; font-weight: 700;'">
                                                            <span th:text="${#numbers.formatDecimal(b.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'">250,000 VND</span>
                                                        </div>
                                                        <span class="badge px-3 py-2"
                                                              th:classappend="${b.status == 1 ? 'bg-success' : (b.status == 0 ? 'bg-warning text-dark' : 'bg-secondary')}"
                                                              th:style="'font-size: 0.8rem; font-weight: 600; border-radius: 20px;'">
                                <i th:class="${b.status == 1 ? 'fas fa-check me-1' : (b.status == 0 ? 'fas fa-clock me-1' : 'fas fa-times me-1')}"></i>
                                <span th:text="${b.status == 1 ? 'Đã xác nhận' : (b.status == 0 ? 'Chờ thanh toán' : 'Đã hủy')}">Status</span>
                            </span>
                                                    </div>

                                                    <!-- Actions -->
                                                    <div class="col-md-4 text-end">
                                                        <div class="d-flex gap-2 justify-content-end flex-wrap">
                                                            <div th:if="${b.status == 0}" class="w-100 mb-2">
                                                                <form th:action="@{/confirm}" method="post" class="d-inline w-100">
                                                                    <input type="hidden" name="status" th:value="${b.status}" />
                                                                    <input type="hidden" name="invoiceId" th:value="${b.invoiceId}" />
                                                                    <button type="submit" class="btn btn-success btn-sm w-100"
                                                                            th:style="'border-radius: 8px; font-weight: 500;'">
                                                                        <i class="fas fa-credit-card me-1"></i>Thanh toán ngay
                                                                    </button>
                                                                </form>
                                                            </div>
                                                            <button type="button"
                                                                    class="btn btn-outline-warning btn-sm"
                                                                    onclick="showTicketDetail(this)"
                                                                    th:style="'border-radius: 8px; font-weight: 500; transition: all 0.3s ease;'"
                                                                    th:data-invoice-id="${b.invoiceId}"
                                                                    th:data-movie-name="${b.movieName}"
                                                                    th:data-booking-date="${b.bookingDate != null ? #dates.format(b.bookingDate, 'yyyy-MM-dd HH:mm') : ''}"
                                                                    th:data-seat-number="${b.seatNumber}"
                                                                    th:data-payment-method="${b.paymentMethod}"
                                                                    th:data-total-amount="${b.totalAmount}"
                                                                    th:data-use-score="${b.useScore}"
                                                                    th:data-add-score="${b.addScore}"
                                                                    th:data-status="${b.status}">
                                                                <i class="fas fa-eye me-1"></i>Chi tiết
                                                            </button>



                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Empty State -->
                                <div class="text-center py-5" th:if="${fullBookingList == null or fullBookingList.isEmpty()}">
                                    <div class="empty-state">
                                        <i class="fas fa-ticket-alt fa-4x text-custom-yellow mb-4"></i>
                                        <h3 class="text-white">No Booking History</h3>
                                        <p class="text-white-50 mb-4">You haven't booked any movie tickets yet. Start exploring our amazing movies!</p>
                                        <a href="/nowShowing" class="btn btn-warning btn-sm">
                                            <i class="fas fa-film me-2"></i>Browse Movies
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Vé đã hủy -->
                <div id="canceled-tickets" class="tab-pane fade" style="display: none;">
                    <div class="card content-card">

                        <div class="card-body">

                            <!-- Nếu có dữ liệu -->
                            <div class="row row-cols-1 row-cols-md-2 g-4" th:if="${bookingList != null and !bookingList.isEmpty()}">
                                <div class="col" th:each="b : ${bookingList}" th:if="${b.getStatus() == -1}">

                                    <div class="ticket-box d-flex flex-md-row flex-column">
                                        <!-- Cột trái: Ảnh phim -->
                                        <div class="ticket-left text-center">
                                            <img th:src="@{/images/placeholder.jpg}"
                                                 alt="Movie Poster"
                                                 class="img-fluid movie-poster"
                                                 style="max-height: 200px; object-fit: cover;" />
                                        </div>

                                        <div class="ticket-right">
                                            <!-- ✅ Tên phim -->
                                            <div class="ticket-row movie-title fw-bold  mb-2" th:text="${b.movieName}">Movie Name</div>
                                            <div class="ticket-row">
                                                Status <span th:text="${b.getStatus()}"></span>
                                            </div>
                                            <div class="ticket-row">
                                                Booking Date: <span th:text="${#dates.format(b.bookingDate, 'yyyy-MM-dd')}">2025-07-03</span>
                                            </div>
                                            <div class="ticket-row">
                                                Seats: <span th:text="${b.seatNumber}">B1,B2</span>
                                            </div>
                                            <div class="ticket-row">
                                                Payment: <span th:text="${b.paymentMethod}">online</span>
                                            </div>
                                            <div class="ticket-row">
                                                <span th:text="${#numbers.formatDecimal(b.totalAmount, 0, 'COMMA', 0, 'POINT')}">150,000</span> VND |
                                                Used: <span th:text="${b.useScore}">0</span> |
                                                +<span th:text="${b.addScore}">10</span> pts
                                            </div>
                                            <div class="ticket-row status">
                                                <strong th:text="'Status: ' + (${b.status == 1 ? 'Confirmed' : 'Pending'})">Status</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Nếu không có đơn nào -->
                            <div class="text-center py-5" th:if="${bookingList == null or bookingList.isEmpty()}">
                                <i class="fas fa-ticket-alt fa-3x text-custom-yellow mb-3"></i>
                                <h3 class="text-white">No Booking History</h3>
                                <p class="text-white-50 mb-3">You haven't booked any movie tickets yet. Start exploring our amazing movies!</p>
                                <a href="/nowShowing" class="btn btn-warning">
                                    <i class="fas fa-film me-1"></i> <span
                                        th:text="#{button.book.ticket}">Browse Movies</span>
                                </a>
                            </div>

                        </div>
                    </div>
                </div>
                <!-- Change Password Tab -->
                <div id="change-password" class="tab-pane fade" style="display: none;">
                    <div class="card content-card">
                        <div class="card-header bg-transparent border-0">
                            <h2 class="text-white mb-0"><i class="fas fa-key me-2 text-custom-yellow"></i>
                                <span th:text="#{profile.change_password}">Change</span>
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-6 mb-4">
                                    <div class="card password-requirements-card h-100">
                                        <div class="card-body">
                                            <h3 class="text-custom-yellow mb-3">
                                                <i class="fas fa-lock me-2"></i> Security Requirements
                                            </h3>
                                            <p class="text-white-50 mb-3" th:text="#{profile.account_security}">For your
                                                account security, please ensure
                                                your password meets the following requirements:</p>
                                            <ul class="list-unstyled">
                                                <li class="mb-2" id="req-length">
                                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                                    <span class="text-white" th:text="#{profile.password_req_length}">At least 8 characters</span>
                                                </li>
                                                <li class="mb-2" id="req-lowercase">
                                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                                    <span class="text-white"
                                                          th:text="#{profile.password_req_lowercase}">Contains lowercase letter</span>
                                                </li>
                                                <li class="mb-2" id="req-uppercase">
                                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                                    <span class="text-white"
                                                          th:text="#{profile.password_req_uppercase}">Contains uppercase letter</span>
                                                </li>
                                                <li class="mb-2" id="req-number">
                                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                                    <span class="text-white" th:text="#{profile.password_req_number}">Contains number</span>
                                                </li>
                                                <li class="mb-2" id="req-special">
                                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                                    <span class="text-white" th:text="#{profile.password_req_special}">Contains special character</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class=" col-lg-6">
                                    <form id="passwordForm" method="post"
                                          th:action="@{/profile/change-password}">
                                        <div class="mb-3">
                                            <label for="currentPassword"
                                                   class="form-label text-custom-yellow fw-semibold"
                                                   th:text="#{profile.current_password}">
                                                <i class="fas fa-lock me-2"></i>
                                                Current Password *
                                            </label>
                                            <div class="input-group">
                                                <input type="password"
                                                       class="form-control form-control-dark"
                                                       id="currentPassword" name="currentPassword"
                                                       required
                                                       th:placeholder="#{profile.enter_current_password}">}">
                                                <button type="button"
                                                        class="btn btn-outline-warning password-toggle-btn"
                                                        onclick="togglePassword('currentPassword')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="newPassword"
                                                   class="form-label text-custom-yellow fw-semibold"
                                                   th:text="#{profile.new_password}">
                                                <i class="fas fa-key me-2"></i> New Password *
                                            </label>
                                            <div class="input-group">
                                                <input type="password"
                                                       class="form-control form-control-dark"
                                                       id="newPassword" name="newPassword" required
                                                       th:placeholder="#{profile.enter_new_password}">}">
                                                <button type="button"
                                                        class="btn btn-outline-warning password-toggle-btn"
                                                        onclick="togglePassword('newPassword')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="confirmPassword"
                                                   class="form-label text-custom-yellow fw-semibold"
                                                   th:text="#{profile.confirm_new_password}">
                                                <i class="fas fa-check-circle me-2"></i> Confirm New
                                                Password *
                                            </label>
                                            <div class="input-group">
                                                <input type="password"
                                                       class="form-control form-control-dark"
                                                       id="confirmPassword" name="confirmPassword"
                                                       required
                                                       th:placeholder="#{profile.confirm_new_password}">}">
                                                <button type="button"
                                                        class="btn btn-outline-warning password-toggle-btn"
                                                        onclick="togglePassword('confirmPassword')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-3 d-flex gap-2">
                                            <button type="button" class="btn btn-danger"
                                                    onclick="resetPasswordForm()"
                                                    th:text="#{button.reset_form}">}">>
                                                <i class="fas fa-undo me-1" ></i> Reset Form
                                            </button>
                                            <button type="submit" class="btn btn-warning"
                                                    th:text="#{button.update_password}">
                                                <i class="fas fa-key me-1"></i> Update Password
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification Container -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1100" id="toastContainer">
        <!-- Toasts will be dynamically inserted here -->
    </div>

    <!-- Ticket Detail Modal -->
    <div class="modal fade" id="ticketDetailModal" tabindex="-1" aria-labelledby="ticketDetailLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ticketDetailLabel">
                        <i class="fas fa-ticket-alt text-custom-yellow me-2"></i>
                        Chi tiết vé
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4" id="ticketDetailBody">
                    <div class="row g-4">
                        <!-- Ticket Header -->
                        <div class="col-12">
                            <div class="ticket-detail-card">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h4 class="text-custom-yellow mb-1" id="modalMovieName">Movie Title</h4>
                                        <span class="badge status-confirmed" id="modalStatus">Đã xác nhận</span>
                                    </div>
                                    <div class="text-end">
                                        <div class="ticket-code-badge" id="modalInvoiceId">#12345</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Booking Information -->
                        <div class="col-md-6">
                            <div class="ticket-detail-card h-100">
                                <h6 class="text-custom-yellow mb-3">
                                    <i class="fas fa-info-circle me-2"></i>Thông tin đặt vé
                                </h6>
                                <div class="detail-row">
                                    <i class="fas fa-calendar-alt icon-warning"></i>
                                    <strong>Ngày & Giờ đặt vé:</strong>
                                    <span id="modalBookingDate">03/07/2025 19:30</span>
                                </div>

                                <div class="detail-row">
                                    <i class="fas fa-chair icon-info"></i>
                                    <strong>Ghế ngồi:</strong>
                                    <span id="modalSeatNumber">B1, B2</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-credit-card icon-success"></i>
                                    <strong>Thanh toán:</strong>
                                    <span id="modalPaymentMethod">Online</span>
                                </div>
                            </div>
                        </div>

                        <!-- Financial Details -->
                        <div class="col-md-6">
                            <div class="ticket-detail-card h-100">
                                <h6 class="text-custom-yellow mb-3">
                                    <i class="fas fa-money-bill-wave me-2"></i>Thông tin thanh toán
                                </h6>
                                <div class="detail-row">
                                    <i class="fas fa-dollar-sign icon-warning"></i>
                                    <strong>Tổng tiền:</strong>
                                    <span class="price-display text-custom-yellow fw-bold" id="modalTotalAmount">150,000 VND</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-star icon-danger"></i>
                                    <strong>Điểm sử dụng:</strong>
                                    <span class="score-used" id="modalUsedScore">0 điểm</span>
                                </div>
                                <div class="detail-row">
                                    <i class="fas fa-plus-circle icon-success"></i>
                                    <strong>Điểm nhận được:</strong>
                                    <span class="score-added" id="modalAddScore">+10 điểm</span>
                                </div>
                            </div>
                        </div>

                        <!-- QR Code & Additional Info -->
                        <div class="col-12">
                            <div class="ticket-detail-card">
                                <div class="row g-3">
                                    <!--                                    được thì thêm QR-->

                                    <!--                                    <div class="col-md-4 text-center">-->
                                    <!--                                        <h6 class="text-custom-yellow mb-3">-->
                                    <!--                                            <i class="fas fa-qrcode me-2"></i>Mã QR-->
                                    <!--                                        </h6>-->
                                    <!--                                        <div class="qr-code-placeholder">-->
                                    <!--                                            <i class="fas fa-qrcode"></i>-->
                                    <!--                                        </div>-->
                                    <!--                                        <small class="text-muted d-block mt-2">Xuất trình tại rạp chiếu phim</small>-->
                                    <!--                                    </div>-->
                                    <div class="col-md-8">
                                        <h6 class="text-custom-yellow mb-3">
                                            <i class="fas fa-exclamation-circle me-2"></i>Lưu ý quan trọng
                                        </h6>
                                        <div class="important-info">
                                            <ul class="list-unstyled mb-0">
                                                <li class="mb-2">
                                                    <i class="fas fa-check text-success me-2"></i>
                                                    Vui lòng có mặt trước 15 phút khi phim bắt đầu
                                                </li>
                                                <li class="mb-2">
                                                    <i class="fas fa-mobile-alt text-info me-2"></i>
                                                    Giữ vé hoặc mã QR để vào rạp
                                                </li>
                                                <li class="mb-2">
                                                    <i class="fas fa-ban text-warning me-2"></i>
                                                    Không được hoàn tiền sau khi mua vé
                                                </li>
                                                <li class="mb-0">
                                                    <i class="fas fa-phone text-primary me-2"></i>
                                                    Hotline hỗ trợ: 1900-xxxx
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>

    </ul>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-1"></i>Close
    </button>
    <button type="button" class="btn btn-warning" onclick="printTicket()">
        <i class="fas fa-print me-1"></i>Print Ticket
    </button>
</div>
</div>
</div>
</div>

<div class="container mt-1" style="position: relative; margin-top: 150px">
    <div th:if="${showPopup}"
         th:classappend="${uploadSuccess} ? 'popup success' : 'popup error'"
         class="position-fixed top-0 end-0 p-3 align-items-center"
         role="alert" aria-live="assertive" aria-atomic="true"
         id="popupNotification">
        <div class="d-flex">
            <div class="toast-body">
                <span th:text="${uploadMessage}"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    onclick="closePopup()" aria-label="Close"></button>
        </div>
    </div>
</div>

</div>

<script th:src="@{/js/theme.js}"></script>

<script>
    // Ticket Detail Modal Functions
    function showTicketDetail(button) {
        const invoiceId = button.getAttribute('data-invoice-id');
        const movieName = button.getAttribute('data-movie-name');
        const bookingDate = button.getAttribute('data-booking-date');
        const showDate = button.getAttribute('data-show-date');
        const scheduleTime = button.getAttribute('data-schedule-time');
        const seatNumber = button.getAttribute('data-seat-number');
        const paymentMethod = button.getAttribute('data-payment-method');
        const totalAmount = button.getAttribute('data-total-amount');
        const useScore = button.getAttribute('data-use-score');
        const addScore = button.getAttribute('data-add-score');
        const status = button.getAttribute('data-status');

        // Gán giá trị vào modal
        document.getElementById('modalMovieTitle').textContent = movieName;
        document.getElementById('modalTicketCode').textContent = '#' + invoiceId;
        document.getElementById('modalBookingDate').textContent = formatDate(bookingDate);
        document.getElementById('modalShowDate').textContent = formatDate(showDate);
        document.getElementById('modalScheduleTime').textContent = scheduleTime; // giờ chiếu không format ngày

        document.getElementById('modalSeats').textContent = seatNumber;
        document.getElementById('modalPaymentMethod').textContent = capitalizeFirst(paymentMethod);
        document.getElementById('modalTotalAmount').textContent = formatCurrency(totalAmount) + ' VND';

        // Status
        const statusBadge = document.getElementById('modalTicketStatus');
        if (status == '1') {
            statusBadge.textContent = 'Confirmed';
            statusBadge.className = 'badge status-confirmed';
        } else {
            statusBadge.textContent = 'Pending';
            statusBadge.className = 'badge status-pending';
        }

        // Score info
        const usedScoreRow = document.getElementById('modalUsedScoreRow');
        const earnedScoreRow = document.getElementById('modalEarnedScoreRow');

        if (useScore && useScore > 0) {
            document.getElementById('modalUsedScore').textContent = useScore;
            usedScoreRow.style.display = 'flex';
        } else {
            usedScoreRow.style.display = 'none';
        }

        if (addScore && addScore > 0) {
            document.getElementById('modalEarnedScore').textContent = '+' + addScore;
            earnedScoreRow.style.display = 'flex';
        } else {
            earnedScoreRow.style.display = 'none';
        }

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('ticketDetailModal'));
        modal.show();
    }


    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function formatOnlyDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB');
    }




    // Utility functions
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatCurrency(amount) {
        return parseFloat(amount).toLocaleString('en-US');
    }

    function capitalizeFirst(str) {
        return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }

    function printTicket() {
        // Create a print-friendly version of the ticket
        const movieTitle = document.getElementById('modalMovieTitle').textContent;
        const ticketCode = document.getElementById('modalTicketCode').textContent;
        const bookingDate = document.getElementById('modalBookingDate').textContent;
        const seats = document.getElementById('modalSeats').textContent;
        const paymentMethod = document.getElementById('modalPaymentMethod').textContent;
        const totalAmount = document.getElementById('modalTotalAmount').textContent;

        const printContent = `
        <div style="font-family: Arial, sans-serif; max-width: 400px; margin: 0 auto; padding: 20px; border: 2px solid #f9a825; border-radius: 10px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #f9a825; margin-bottom: 5px;">Top1Cinema</h2>
                <p style="margin: 0; color: #666;">Movie Ticket</p>
            </div>

            <div style="border-bottom: 1px dashed #ccc; padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #333; margin-bottom: 10px;">${movieTitle}</h3>
                <p style="margin: 5px 0;"><strong>Ticket:</strong> ${ticketCode}</p>
                <p style="margin: 5px 0;"><strong>Date:</strong> ${bookingDate}</p>
                <p style="margin: 5px 0;"><strong>Seats:</strong> ${seats}</p>
                <p style="margin: 5px 0;"><strong>Payment:</strong> ${paymentMethod}</p>
                <p style="margin: 5px 0;"><strong>Total:</strong> ${totalAmount}</p>
            </div>

            <div style="text-align: center; font-size: 12px; color: #666;">
                <p>Please arrive 15 minutes before showtime</p>
                <p>Valid ID may be required</p>
            </div>
        </div>
    `;

        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Ticket - ' + movieTitle + '</title></head><body>');
        printWindow.document.write(printContent);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    // Filter and Search Functions (updated for row layout)
    function filterTickets() {
        const searchTerm = document.getElementById('searchTicket').value.toLowerCase();
        const ticketCards = document.querySelectorAll('.ticket-card');
        let hasResults = false;

        ticketCards.forEach(card => {
            const movieName = card.getAttribute('data-movie').toLowerCase();
            const seats = card.getAttribute('data-seats').toLowerCase();
            const ticketId = card.getAttribute('data-ticket-id').toLowerCase();

            if (movieName.includes(searchTerm) || seats.includes(searchTerm) || ticketId.includes(searchTerm)) {
                card.parentElement.style.display = 'block';
                hasResults = true;
            } else {
                card.parentElement.style.display = 'none';
            }
        });

        document.getElementById('noResults').style.display = hasResults ? 'none' : 'block';
    }

    function filterByStatus() {
        const statusFilter = document.getElementById('statusFilter').value;
        const ticketCards = document.querySelectorAll('.ticket-card');
        let hasResults = false;

        ticketCards.forEach(card => {
            const status = card.getAttribute('data-status');

            if (statusFilter === 'all' || status === statusFilter) {
                card.parentElement.style.display = 'block';
                hasResults = true;
            } else {
                card.parentElement.style.display = 'none';
            }
        });

        document.getElementById('noResults').style.display = hasResults ? 'none' : 'block';
    }

    function sortTickets() {
        const sortBy = document.getElementById('sortBy').value;
        const ticketsContainer = document.querySelector('.tickets-container');
        const ticketCards = Array.from(document.querySelectorAll('.ticket-card')).map(card => card.parentElement);

        ticketCards.sort((a, b) => {
            const cardA = a.querySelector('.ticket-card');
            const cardB = b.querySelector('.ticket-card');

            switch(sortBy) {
                case 'date':
                    const dateA = new Date(cardA.getAttribute('data-booking-date') || 0);
                    const dateB = new Date(cardB.getAttribute('data-booking-date') || 0);
                    return dateB - dateA; // Newest first

                case 'movie':
                    const movieA = cardA.getAttribute('data-movie') || '';
                    const movieB = cardB.getAttribute('data-movie') || '';
                    return movieA.localeCompare(movieB);

                case 'total':
                    const totalA = parseFloat(cardA.getAttribute('data-total-amount') || 0);
                    const totalB = parseFloat(cardB.getAttribute('data-total-amount') || 0);
                    return totalB - totalA; // Highest first

                default:
                    return 0;
            }
        });

        // Re-append sorted cards
        const bookingListContainer = ticketsContainer.querySelector('[th\\:if="${bookingList != null and !bookingList.isEmpty()}"]');
        if (bookingListContainer) {
            ticketCards.forEach(card => bookingListContainer.appendChild(card));
        }
    }

    function toggleSortOrder() {
        const icon = document.getElementById('sortIcon');
        const isAscending = icon.classList.contains('fa-sort-up');

        // Toggle icon
        icon.classList.toggle('fa-sort-up');
        icon.classList.toggle('fa-sort-down');

        // Re-sort with new order
        const sortBy = document.getElementById('sortBy').value;
        const ticketsContainer = document.querySelector('.tickets-container');
        const ticketCards = Array.from(document.querySelectorAll('.ticket-card')).map(card => card.parentElement);

        ticketCards.sort((a, b) => {
            const cardA = a.querySelector('.ticket-card');
            const cardB = b.querySelector('.ticket-card');
            let result = 0;

            switch(sortBy) {
                case 'date':
                    const dateA = new Date(cardA.getAttribute('data-booking-date') || 0);
                    const dateB = new Date(cardB.getAttribute('data-booking-date') || 0);
                    result = dateB - dateA;
                    break;

                case 'movie':
                    const movieA = cardA.getAttribute('data-movie') || '';
                    const movieB = cardB.getAttribute('data-movie') || '';
                    result = movieA.localeCompare(movieB);
                    break;

                case 'total':
                    const totalA = parseFloat(cardA.getAttribute('data-total-amount') || 0);
                    const totalB = parseFloat(cardB.getAttribute('data-total-amount') || 0);
                    result = totalB - totalA;
                    break;
            }

            // Reverse if ascending
            return isAscending ? -result : result;
        });

        // Re-append sorted cards
        const bookingListContainer = ticketsContainer.querySelector('[th\\:if="${bookingList != null and !bookingList.isEmpty()}"]');
        if (bookingListContainer) {
            ticketCards.forEach(card => bookingListContainer.appendChild(card));
        }
    }

    function clearFilters() {
        document.getElementById('searchTicket').value = '';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('sortBy').value = 'date';

        // Reset sort icon
        const sortIcon = document.getElementById('sortIcon');
        if (sortIcon) {
            sortIcon.className = 'fas fa-sort';
        }

        const ticketCards = document.querySelectorAll('.ticket-card');
        ticketCards.forEach(card => {
            card.parentElement.style.display = 'block';
        });

        document.getElementById('noResults').style.display = 'none';

        // Re-sort by default (date)
        sortTickets();
    }
</script>

</body>
</html>
